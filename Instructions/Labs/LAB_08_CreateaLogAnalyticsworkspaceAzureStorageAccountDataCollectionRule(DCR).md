---
lab:
  title: 08 - Log Analytics ワークスペース、Azure ストレージ アカウント、データ収集ルール (DCR) を作成する
  module: Module 03 - Configure and manage threat protection by using Microsoft Defender for Cloud
---

# ラボ 08: Log Analytics ワークスペース、Azure ストレージ アカウント、データ収集ルール (DCR) を作成する

# 受講生用ラボ マニュアル

## ラボのシナリオ

金融テクノロジ企業の Azure セキュリティ エンジニアは、財務トランザクションの処理や顧客の機密データの管理に使用されるすべての Azure Virtual Machine (VM) の監視とセキュリティの可視性を強化する必要があります。 セキュリティ チームは、潜在的な脅威を検出し、システム パフォーマンスを最適化するために、これらの VM からの詳細なログとパフォーマンス指標が必要です。 最高情報セキュリティ責任者 (CISO) から、セキュリティ イベント、システム ログ、およびパフォーマンス カウンターを収集するソリューションを実施するよう求められました。 ログの収集とパフォーマンスの監視を一元化するために、Azure Monitor エージェント (AMA) とデータ収集ルール (DCR) を構成する任務を与えられました。



> このラボのすべてのリソースについて、**米国東部**リージョンを使用しています。 これがクラスで使用するリージョンであることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1:Azure Virtual Machine をデプロイする
- 演習 2:Log Analytics ワークスペースを作成する
- 演習 3:Azure ストレージ アカウントを作成する
- 演習 4: データ収集ルールを作成する
  
## 手順

### 演習 1:Azure Virtual Machine をデプロイする

### 演習のタイミング:10 分

この演習では、次のタスクを実行します。 

#### タスク 1: Azure 仮想マシンをデプロイする

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**:このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure portal にサインインします。

2. Azure portal の右上にある最初のアイコンをクリックして、Cloud Shell を開きます。 メッセージが表示されたら、**[PowerShell]** を選択します。

3. Cloud Shell ペインの左上隅にあるドロップダウン メニューで **[PowerShell]** が選択されていることを確認します。

4. **[作業の開始]** ウィンドウで、既定の設定をそのまま使用します。**開始するには、サブスクリプションを選択します。必要に応じて、セッション間でファイルを保持するためのストレージ アカウントをマウントできます。ストレージ アカウントは必須ではありません。**

5. **[サブスクリプション]** ドロップダウン メニューから、お使いの **lodsubscription** を選びます。

6. **[既存のプライベート仮想ネットワークを使用する]** をオフのままにして、**[適用]** をクリックします。

7. [Cloud Shell] ペイン内の PowerShell セッションで、次の手順を実行して、このラボで使用するリソース グループを作成します。
  
    ```powershell
    New-AzResourceGroup -Name AZ500LAB131415 -Location 'EastUS'
    ```

    >**注**: このリソース グループは、ラボ 8、9、および 10 に使用されます。

8. Cloud Shell ウィンドウ内の PowerShell セッションで次を実行して、ホスト (EAH) で暗号化を有効にします。
   
   ```powershell
    Register-AzProviderFeature -FeatureName "EncryptionAtHost" -ProviderNamespace Microsoft.Compute 
    ```

5. [Cloud Shell] ペイン内の PowerShell セッションで、次の手順を実行して、新しい Azure 仮想マシンを作成します。 

    ```powershell
    New-AzVm -ResourceGroupName "AZ500LAB131415" -Name "myVM" -Location 'EastUS' -VirtualNetworkName "myVnet" -SubnetName "mySubnet" -SecurityGroupName   "myNetworkSecurityGroup" -PublicIpAddressName "myPublicIpAddress" -PublicIpSku Standard -OpenPorts 80,3389 -Size Standard_D2s_v3 
    ```
    
6.  資格情報の入力を求められた場合:

    |設定|値|
    |---|---|
    |User |**localadmin**|
    |Password|**ラボ 02 > 演習 2 > タスク 1 > 手順 3 で作成した個人用パスワードを使用してください。**|

    >**注**: デプロイが完了するまで待ちます。 

7. [Cloud Shell] ペイン内の PowerShell セッションで、次のコマンドを実行して、**myVM** という名前の仮想マシンが作成され、その **[ProvisioningState]** が **[成功]** であることを確認します。

    ```powershell
    Get-AzVM -Name 'myVM' -ResourceGroupName 'AZ500LAB131415' | Format-Table
    ```

8. [Cloud Shell] ペインを閉じます。 

### 演習 2:Log Analytics ワークスペースを作成する

### 演習のタイミング:10 分

この演習では、次のタスクを実行します。 

#### タスク 1:Log Analytics ワークスペースを作成する

このタスクでは、Log Analytics ワークスペースを作成します。 

1. Azure portal で、Azure portal ページの上部にある **[リソース、サービス、ドキュメントを検索する]** テキスト ボックスで、「**Log Analytics ワークスペース**」と入力し、**Enter** キーを押します。

2. **[Log Analytics ワークスペース]** ブレードで、 **[+ 作成]** をクリックします。

3. **[Log Analytics ワークスペースの作成]** ブレードの **[基本]** タブで、次の設定を指定します (他の設定は既定値のままにします)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|**AZ500LAB131415**|
    |名前|グローバルにユニークな任意の名前|
    |リージョン|**米国東部**|

4. **[Review + create](レビュー + 作成)** を選択します。

5. **[Log Analytics ワークスペースの作成]** ブレードの **[確認および作成]** タブで、 **[作成]** を選択します。

### 演習 3:Azure ストレージ アカウントを作成する

### 推定時間:10 分

この演習では、次のタスクを実行します。

#### タスク 1:Azure ストレージ アカウントを作成する

このタスクでは、ストレージ アカウントを作成します。

1. Azure portal の「**リソース、サービス、ドキュメントの検索**」テキスト ボックスで、Azure portal ページの上部に「**ストレージ アカウント**」と入力し、**Enter** キーを押します。

2. Azure portal の **[ストレージ アカウント]** ブレードで、**[+ 作成]** ボタンをクリックして新しいストレージ アカウントを作成します。

3. 「**ストレージ アカウントの作成**」ブレードの「**基本**」タブで、次の設定を指定します (他の設定は既定値のままにします)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|**AZ500LAB131415**|
    **インスタンスの詳細** |ストレージ アカウント名|文字と数字で構成される 3 ～ 24 文字の長さのグローバルに一意の名前| |リージョン|**(米国) EastUS**|
    |プライマリ サービス|**Azure Blob Storage または Azure Data Lake Storage Gen 2**|
    |パフォーマンス|**Standard (汎用 v2 アカウント)**|
    |冗長性|**ローカル冗長ストレージ (LRS)**|

5. **[ストレージ アカウントの作成]** ブレードの **[基本]** タブで、**[レビュー + 作成]** をクリックします。 検証プロセスが完了したら、 **[作成]** をクリックします。

    >**注**:ストレージ アカウントが作成されるのを待ちます。 これには 2 分ほどかかります。

### 演習 4: データ収集ルールを作成する

### 推定時間:15 分

この演習では、次のタスクを実行します。

#### タスク 1:データ収集ルールを作成する。

このタスクでは、データ収集ルールを作成します。

1. Azure portal で、Azure portal ページの上部にある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスに「**監視**」と入力し、**Enter** キーを押します。

2. **[監視設定]** ブレードで、 **[データ収集ルール]** をクリックします。

3. **[+ 作成]** をクリックして新しいデータ収集ルールを作成します。

4. **[データ収集ルールの作成]** ブレードの **[基本]** タブで、以下の設定を指定します。
  
    |設定|Value|
    |---|---|
    **ルールの詳細** |ルール名|**DCR1**|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前| |リソース グループ|**AZ500LAB131415**|
    |リージョン|**米国東部**|
    |プラットフォームの種類|**Windows**|
    |データ収集エンドポイント|*空白のままにする*|

    ![[データ収集ルールの作成] の基本タブのスクリーンショット。](../media/crete-a-data-collection-rule-basics-tab.png)


5. **[次へ: リソース >]** というラベルの付いたボタンをクリックして次に進みます。
   
6. **[リソース]** ページで、**[+ リソースの追加]** を選択します。

7. **[スコープの選択]** テンプレートで、**[スコープ]** の **[サブスクリプション]** ボックスをオンにします。

8. **[スコープの選択]** テンプレートの下部にある **[適用]** をクリックします。

9. **[リソース]** ページの下部にある **[次へ: 収集と配信]** を選択します。

10. **[+ データ ソースの追加]** をクリックしてから、**[データ ソースの追加]** ページで、**[データ ソースの種類]** ドロップダウン メニューを変更して **[パフォーマンス カウンター]** を表示します。 以下の既定の設定はそのままにします。

    |設定|値|
    |---|---|
    |**パフォーマンス カウンター**|**サンプル レート (秒)**|
    |CPU|60|
    |メモリ|60|
    |ディスク|60|
    |ネットワーク|60|

   ![[データ収集ルール] の [収集と配信] タブのスクリーンショット。](../media/crete-a-data-collection-rule-collectanddeliver-tab.png)

11. **[次へ: 移行先 >]** というラベルの付いたボタンをクリックして次に進みます。
  
12. **[+ 宛先の追加]** をクリックし、**[宛先の種類]** ドロップダウン メニューを変更して **[Azure Monitor ログ]** を表示します。 **[サブスクリプション]** ウィンドウで、"サブスクリプション" が表示されていることを確認してから、前に作成した Log Analytics ワークスペースを反映するように **[アカウントまたは名前空間]** ドロップダウン メニューを変更します。**

13. ページ下部の **[データ ソースの追加]** をクリックします。
    
    ![[データ収集ルール] ページの [データ ソースの追加] ページのスクリーンショット。](../media/crete-a-data-collection-rule-add-datasource.png)

14. **[Review + create](レビュー + 作成)** をクリックします。

    ![[データ収集ルール] ウィザードの [確認および作成] タブのスクリーンショット。](../media/crete-a-data-collection-rule-reviewcreate-tab.png)

15. **Create** をクリックしてください。

> 結果:Azure 仮想マシン、Log Analytics ワークスペース、Azure ストレージ アカウント、データ収集ルールをデプロイして、Azure Monitor エージェントを使用して仮想マシンからイベントとパフォーマンス カウンターを収集しました。

>**注**: このラボからリソースを削除しないでください。それらのリソースは、Microsoft Defender for Cloud ラボ、「VM で Just-In-Time アクセスを有効にする」ラボ、および Microsoft Sentinel ラボで必要です
 
