---
lab:
    title: '12 - サービス エンドポイントとストレージの保護'
    module: 'モジュール 03 – データとアプリケーションのセキュリティ保護'
---

# 課題 12: サービス エンドポイントとストレージの保護
# 受講生用ラボ マニュアル

## ラボ シナリオ

Azure ファイル共有のセキュリティ保護を実証するための概念実証を作成するよう求められました。具体的には、次のことを行います。
	
- Azure Storage に向かうトラフィックが常に Azure バックボーン ネットワーク内にとどまるように、ストレージ エンドポイントを作成します。
- 特定のサブネットのリソースのみがストレージにアクセスできるように、ストレージ エンドポイントを構成します。
- 特定のサブネット外のリソースがストレージにアクセスできないことを確認します。 

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: サービス エンドポイントとセキュリティ ストレージ

### 演習 1: サービス エンドポイントとセキュリティ ストレージ

### 予想時間: 45 分

この演習では、次のタスクを行います。

- タスク 1: 仮想ネットワークを作成する
- タスク 2: 仮想ネットワークにサブネットを追加し、ストレージ エンドポイントを構成する
- タスク 3: サブネットへのアクセスを制限するようにネットワーク セキュリティ グループを構成する
- タスク 4: ファイル共有でストレージ アカウントを作成する
- タスク 5: 指定されたサブネットに仮想マシンをデプロイする
- タスク 6: プライベート サブネットからのストレージ接続をテストして、アクセスが許可されていることを確認します。
- タスク 7: パブリック サブネットからのストレージ接続をテストして、アクセスが拒否されたことを確認します 

#### タスク 1: 仮想ネットワークを作成する

このタスクでは、Virtual Network を作成します。

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal の 「**参照資料、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に **仮想ネットワーク** をタイプし、**Enter** キーを押します。

1. 「**Virtual Networks**」ブレードで、「**+ 作成**」をクリックします。

1. 「**仮想ネットワークの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定し (他の設定は既定値のままにします)、「**次:IP アドレス**」 をクリックします

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|**新規作成**をクリックし、**AZ500Lab12**という名前をタイプする|
    |名前|**myVirtualNetwork**|
    |地域|**(US)米国東部**|

1. 「**仮想ネットワークの作成**」 ブレードの 「**IP アドレス**」 タブで、「**IPv4 アドレス空間**」 を 「**10.0.0.0/16**」 に設定し、「**サブネット名**」 列で 「**default**」 をクリックし、「**サブネットの編集**」 ブレードで次の設定を指定して 「**保存**」 をクリックします。

    |設定|値|
    |---|---|
    |サブネット名|**public**|
    |サブネット アドレス範囲|**10.0.0.0/24**|

1. 「**仮想ネットワークの作成**」 ブレードの 「**IP アドレス**」 タブに戻り、「**確認および作成**」をクリックします。

1. 「**仮想ネットワークの作成**」 ブレードの 「**確認および作成**」 タブで、「**作成**」 をクリックします。

#### タスク 2: 仮想ネットワークにサブネットを追加し、ストレージ エンドポイントを構成する

このタスクでは、別のサブネットを作成し、そのサブネット上のサービス エンドポイントを有効にします。サービス エンドポイントは、サービスごと、サブネットごとに有効になります。 

1. Azure portal で、**リソース グループ**ブレードに戻ります。

1. **仮想ネットワーク**ブレードで、**myVirtualNetwork**エントリをクリックします。

1. **myVirtualNetwork**ブレードの**設定**セクションで、**サブネット**をクリックします。

1. 「**myVirtualNetwork \| サブネット**」ブレードで、「**+ サブネット**」 をクリックします。 

1. **サブネットの追加**ブレードで、次の設定を指定します (他の設定はデフォルト値のままにします)。

    |設定|値|
    |---|---|
    |サブネット名|**private**:|
    |サブネット アドレス範囲|**10.0.1.0/24**|
    |サービス エンドポイント|**Microsoft.Storage**|

1. **「サブネットの追加」** ブレードで、**「保存」** をクリックして新しいサブネットを追加します。

    >**注**: 仮想ネットワークには、**public** と **private** の 2 つのサブネットがあります。 
	
#### タスク 3: サブネットへのアクセスを制限するようにネットワーク セキュリティ グループを構成する

このタスクでは、2 つの送信セキュリティ規則（ストレージとインターネット）と1つの受信セキュリティ規則（RDP）を持つネットワーク セキュリティ グループを作成します。また、ネットワーク セキュリティ グループをプライベート サブネットに関連付けます。これにより、そのサブネットに接続されている Azure VM からの送信トラフィックが制限されます。

1. Azure portal で、Azure portal の上部にある 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、 **ネットワーク セキュリティ グループ**と入力 し、**Enter** キーを押します。

1. 「**ネットワーク セキュリティ グループ**」ブレードで、「**+ 作成**」をクリックします。

1. **ネットワーク セキュリティ グループの作成**ブレードの**基本**タブで、次の設定を指定します。 

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab12**|
    |名前|**myNsgPrivate**|
    |リージョン|**(US)米国東部**|

1. **「確認および作成」** をクリックし、**「作成」** をクリックします。

    >**注**: 次の手順では、Azure Storage サービスとの通信を許可する送信セキュリティ規則を作成します。 

1. Azure portal で、「**ネットワーク セキュリティ グループ**」 ブレードに戻り、**myNsgPrivate** エントリをクリックします。

1. 「**myNsgPrivate**」 ブレードの 「**設定**」 セクションで、「**送信セキュリティ規則**」 をクリックします。

1. 「**myNsgPrivate \| 送信セキュリティ規則**」 ブレードで、「**+ 追加**」 をクリックします。

1. 「**送信セキュリティ規則の追加**」ブレードで、次の設定を指定して、Azure Storage への送信トラフィックを明示的に許可します (他のすべての値をデフォルト設定のままにします)。 

    |設定|値|
    |---|---|
    |ソース|**VirtualNetwork**,|
    |送信元ポートの範囲|**\***|
    |宛先|ドロップダウン リストで、「**サービス タグ**」を選択し、**ストレージ** をクリックします|
    |宛先ポート範囲|**\***|
    |プロトコル|**任意**|
    |アクション|**許可**|
    |優先度|**1000**|
    |名前|**Allow-Storage-All**|

1. 「**送信セキュリティ ルールの追加**」ブレードで、「**追加**」 をクリックして新しい送信ルールを作成します。 

1. **myNsgPrivate** ブレードの 「**設定**」 セクションで、「**送信セキュリティ規則**」 をクリックし、「**+ 追加**」 をクリックします。

1. **送信セキュリティルールの追加** ブレードで、インターネットへの送信トラフィックを明示的に拒否するように次の設定を指定します (他の設定はすべて既定値のままにします) 

    |設定|値|
    |---|---|
    |ソース|**VirtualNetwork**,|
    |送信元ポートの範囲|**\***|
    |宛先|ドロップダウン リストで「**サービス タグ**」を選択し、「**インターネット**」をクリックします。|
    |宛先ポート範囲|**\***|
    |プロトコル|**任意**|
    |アクション|**拒否**|
    |優先度|**1100**|
    |名前|**Deny-Internet-All**|

    >**注**: この規則は、送信インターネット通信を許可するすべてのネットワーク セキュリティ グループのデフォルト規則を上書きします。 

    >**注**: 次の手順では、サブネットへのリモート デスクトップ プロトコル (RDP) トラフィックを許可する受信セキュリティ規則を作成します。この規則は、インターネットからのすべての受信トラフィックを拒否するデフォルトのセキュリティ規則をオーバーライドします。サブネットへのリモート デスクトップ接続が許可されているため、後の手順で接続をテストできます。

1. 「**送信セキュリティ ルールの追加**」ブレードで、「**追加**」をクリックして新しい送信ルールを作成します。 

1. 「**myNsgPrivate \| 送信セキュリティ規則** ブレードの 「**設定**」 セクションで、「**受信セキュリティ規則**」、「**+追加**」 を順にクリックします。

1. 「**受信セキュリティ規則の追加**」 ブレードで、次の設定を指定します (他の値はすべて既定値のままにします)。 

    |設定|値|
    |---|---|
    |ソース|**任意**|
    |送信元ポートの範囲|**\***|
    |宛先|"VirtualNetwork",|
    |宛先ポート範囲|**3389**|
    |プロトコル|**TCP**|
    |アクション|**許可**|
    |優先度|**1200**|                                                    
    |名前|**Allow-RDP-All**|

1. 「**受信セキュリティ規則の追加**」 ブレードで、「**追加**」 をクリック して新しい受信規則を作成します。 

    >**注**: 次に、ネットワーク セキュリティ グループを Private サブネットに関連付けます。

1. 「**サブネット**」 ブレードで、「**+ 関連付け**」 を選択し、「**サブネットの関連付け**」 セクションで次の設定を指定してから、「**OK**」 をクリックします。

    |設定|値|
    |---|---|
    |バーチャル ネットワーク|**myVirtualNetwork**|
    |サブネット|**private**|

#### タスク 4: ファイル共有でストレージ アカウントを作成する

このタスクでは、ファイル共有を使用してストレージ アカウントを作成し、ストレージ アカウント キーを取得します。  

1. Azure portal で、Azure ポータルの上部にある 「 **リソース、サービス、ドキュメントの検索** 」 テキスト ボックスで、**ストレージ アカウント**と入力し、**Enter** キーを押します。

1. 「**ストレージ アカウント**」 ブレードで 「**作成**」 をクリックします。

1. 「**ストレージ アカウントを作成する**」 ブレードの 「**基本**」 タブで、次の設定を指定します (他の設定はデフォルト値のままにします)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab12**|
    |ストレージ アカウント名|文字と数字で構成される、長さが 3 から 24 のグローバルに一意の名前|
    |地域|**(US)米国東部**|
    |パフォーマンス|**Standard**|
    |アカウントの種類|**StorageV2 (汎用 v2)**|
    |冗長性|**ローカル冗長ストレージ (LRS)**|

1. 「**ストレージ アカウントを作成する**」 ブレードの 「**基本**」 タブで、「**確認および作成**」 をクリックし、検証プロセスが完了するのを待ってから、「**作成**」 をクリックします。

    >**注**: ストレージ アカウントが作成されるのを待ちます。これにはおよそ 2 分かかります。

1. Azure portal の、Azure portal ページの上部にある **「ソース、サービス、ドキュメントの検索」** テキスト ボックスで、 **「リソース グループ」**と入力し、**「Enter」** キーを押します。

1. 「**リソース グループ**」 ブレードのリソース グループの一覧で、「**AZ500Lab12**」 エントリをクリックします。

1. **AZ500Lab12** リソース グループ ブレードのリソース リストで、新しく作成されたストレージ アカウントを表すエントリをクリックします。

1. ストレージ アカウントの「**概要**」ブレードで、「**データ ストレージ**」タブの「**ファイル共有**」をクリックし、「**+ ファイル共有**」をクリックします。

1. 「**新しいファイルの共有**」 ブレードで、次の設定を指定します。

    |設定|値|
    |---|---|
    |名前|**my-file-share**|

1. **新しいファイル共有**ブレードで、**作成**をクリックします。

    >**注**: 次に、Azure ファイル共有へのドライブ マッピングを作成する PowerShell スクリプトを取得して記録します。 

1. 「ストレージ アカウント」 ブレードで、 「ファイル共有の一覧」から、「 **my-file-share**」 をクリックします。

1. **my-file-share**ブレードで、「**接続**」 をクリックします。

1. 「**接続**」 ブレードの 「**Windows**」 タブで、ファイル共有への Z ドライブのマッピングを作成する PowerShell スクリプトをコピーします。 

    >**注**: このスクリプトを記録します。このラボの後半で、**Private** サブネット上の Azure Virtual Machine からファイル共有をマッピングするために、これが必要になります。

1. ストレージ アカウント ブレードに戻り、「**セキュリティ + ネットワーク**」セクションで、「**ネットワーク**」をクリックします。

1. 「**ファイアウォールと仮想ネットワーク**」ブレードで「**選択したネットワーク**」オプションを選択し、「**+ 既存の仮想ネットワークを追加**」リンクをクリックします。 

1. **「ネットワークを追加する」** ブレードで、次の設定を指定します。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |仮想ネットワーク|**myVirtualNetwork**|
    |サブネット|**プライベート**|

1. 「**ネットワークの追加**」 ブレードで、「**+ 追加**」 をクリックします。 

1. ストレージ アカウントのブレードに戻り、「**保存**」 をクリックします。

    >**注**: ラボのこの時点で、仮想ネットワーク、ネットワーク セキュリティ グループ、およびファイル共有のあるストレージ アカウントを構成しました。 

#### タスク 5: 指定されたサブネットに仮想マシンをデプロイする

このタスクでは、プライベート サブネットとパブリック サブネットに 1 つずつ、2 つの仮想マシンを作成します。 

>**注**: 最初の仮想マシンは Private サブネットに接続されます。

1. Azure portal の 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に「**Virtual Machines**」と入力し、**Enter** キーを押します。

1. 「**仮想マシン**」ブレードで、「**+追加**」をクリックし、ドロップダウンリストで「**+ 仮想マシン**」をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab12**|
    |仮想マシン名|**myVmPrivate**|
    |地域|**(US) 米国東部**|
    |イメージ|**Windows Server 2019 Datacenter - Gen 2**|
    |ユーザー名|**localadmin**|
    |パスワード|**Pa55w.rd1234**|
    |パブリック受信ポート|**なし**|
    |既存の Windows Server ライセンスを使用しますか?|**いいえ**|

    >**注**: 公開の受信ポートの場合、事前に作成された NSG に依存します。 

1. 「**次:ディスク >**」 をクリックし、「**仮想マシンの作成**」 ブレードの 「**ディスク**」 タブで、「**OS ディスクの種類**」 を 「**Standard HDD**」 に設定し、「**次:ネットワーク**」 をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**ネットワーク**」 タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

    |設定|値|
    |---|---|
    |仮想ネットワーク|**myVirtualNetwork**|
    |サブネット|**private (10.0.1.0/24)**|
    |パブリック IP|新規作成をクリックして名前を入力 **mongodbserver-ip**|
    |NIC ネットワーク セキュリティ グループ|**なし**|

1. 「**次:管理 >**」、「**仮想マシンの作成**」 ブレードの 「**管理**」 タブで、デフォルト設定を受け入れ、「**確認および作成**」 をクリックします。

1. 「**Review + create**」ブレードで検証が成功したことを確認して、「**作成**」をクリックします。

    >**注**: 2 番目の仮想マシンは Public サブネットに接続されます。

1. 「**仮想マシン**」 ブレードで、「**+作成**」 をクリックし、ドロップダウンリストで 「**+仮想マシン**」 をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab12**|
    |仮想マシン名|**myVmPublic**|
    |地域|**(US) 米国東部**|
    |イメージ|**Windows Server 2019 Datacenter - Gen 2**|
    |ユーザー名|**localadmin**|
    |パスワード|**Pa55w.rd1234**|
    |パブリック受信ポート|**なし**|
    |既存の Windows Server ライセンスを使用しますか?|**いいえ**|

    >**注**: 公開の受信ポートの場合、事前に作成された NSG に依存します。 

1. 「**次:ディスク >**」 をクリックし、「**仮想マシンの作成**」 ブレードの 「**ディスク**」 タブで、「**OS ディスクの種類**」 を 「**Standard HDD**」 に設定し、「**次:ネットワーク**」 をクリックします。

1. 「**仮想マシンの作成**」 ブレードの 「**ネットワーク**」 タブで、次の設定を指定します (既定値を他のユーザーのままにします)。

    |設定|値|
    |---|---|
    |バーチャル ネットワーク|**myVirtualNetwork**|
    |サブネット|**public (10.0.0.0/24)**|
    |パブリック IP|新規作成をクリックして名前を入力 **myVmPublic-ip**|
    |NIC ネットワーク セキュリティ グループ|**なし**|

1. 「**次:管理 >**」をクリックし、「**仮想マシンの作成**」 ブレードの 「**管理**」 タブで、デフォルト設定を受け入れ、「**確認および作成**」 をクリックします。

1. 「**Review + create**」ブレードで検証が成功したことを確認して、「**作成**」をクリックします。

    >**注**: **myVMPrivate** Azure VM のデプロイが完了したら、次のタスクに進むことができます。

#### タスク 6: プライベート サブネットからのストレージ接続をテストして、アクセスが許可されていることを確認します。

このタスクでは、リモート デスクトップ経由で myVMPrivate 仮想マシンに接続し、ドライブをファイル共有にマップします。 

1. **Virtual Machines** ブレードに移動します。 

1. 「**Virtual Machines**」 ブレードで、「**myVMPrivate**」 エントリをクリックします。

1. **myVMPrivate** ブレードで 「**接続**」 をクリックし、ドロップ ダウン メニューの 「**RDP**」 をクリックします。 

1. 「**RDP ファイルのダウンロード**」 をクリックし、リモート デスクトップ経由で **myVMPrivate** Azure VM に接続するために使用します。認証を求められたら、次の資格情報を入力します。

    |設定|値|
    |---|---|
    |ユーザー名|**localadmin**|
    |パスワード|**Pa55w.rd1234**|

    >**注**: リモート デスクトップ セッションが開き、サーバー マネージャーが読み込まれるまで待ってください。

    >**注**: ドライブ Z を Windows Server 2019 のコンピューターのリモート デスクトップ セッション内の Azure ファイル共有にマップします。

1. **myVMPrivate** へのリモート デスクトップ セッション内で、「**スタート**」 をクリックし、「**Windows PowerShell ISE**」 をクリックします。

1. **Windows PowerShell ISE** ウィンドウで、 **スクリプト**ウィンドウを開き、このラボで前に記録した PowerShell スクリプトを貼り付けて実行します。スクリプトの形式は次のとおりです

    ```powershell
    $connectTestResult = Test-NetConnection -ComputerName <storage_account_name>.file.core.windows.net -Port 445
    if ($connectTestResult.TcpTestSucceeded) {
       # Save the password so the drive will persist on reboot
       cmd.exe /C "cmdkey /add:`"<storage_account_name>.file.core.windows.net`" /user:`"Azure\<storage_account_name>`"  /pass:`"<storage_account_key>`""
       # Mount the drive
       New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<storage_account_name>.file.core.windows.net\my-file-share" -Persist
    } else {
       Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
    }
    ```
    >**注**: `<storage-account-name>` プレースホルダーは、ファイル共有をホストするストレージ アカウントの名前を表し、 `<storage_account_name>`はそのプライマリ キーを表します

1. Explorer を起動して、Z: ドライブのマッピングが正常に作成されたことを確認します。

1. 次に、**Windows PowerShell ISE** コンソールのコンソール ウィンドウから次を実行して、仮想マシンがインターネットに送信接続がないことを確認します。

    ```powershell
    Test-NetConnection -ComputerName www.bing.com -Port 80
    ```

    >**注**: private のサブネットに関連付けられているネットワーク セキュリティ グループがインターネットへの発信アクセスを許可していないため、テストは失敗します。

1. **myVmPrivate** Azure VM へのリモート デスクトップ セッションを終了します。

    >**注**: この時点で、private のサブネット内の仮想マシンがストレージ アカウントにアクセスできることを確認しました。 

####  タスク 7: Public サブネットからのストレージ接続をテストして、アクセスが拒否されたことを確認します 

1. **Virtual Machines** ブレードに移動します。 

1. **Virtual Machines** ブレードで、「**myVMPublic**」 エントリをクリックします。

1. **myVMPublic** ブレードで 「**接続**」 をクリックし、ドロップ ダウン メニューの 「**RDP**」 をクリックします。 

1. 「**RDP ファイルのダウンロード**」 をクリックし、リモート デスクトップ経由で **myVMPublic** Azure VM に接続するために使用 します。認証を求められたら、次の資格情報を入力します。

    |設定|値|
    |---|---|
    |ユーザー名|**localadmin**|
    |パスワード|**Pa55w.rd1234**|

    >**注**: リモート デスクトップ セッションが開き、サーバー マネージャーが読み込まれるまで待ってください。

    >**注**: ドライブ Z を Windows Server 2019 のコンピューターのリモート デスクトップ セッション内の Azure ファイル共有にマップします。

1. **myVMPublic** へのリモート デスクトップ セッションで、**「スタート」** をクリックして、**「Windows PowerShell ISE」** をクリックします。

1. **Windows PowerShell ISE** ウィンドウで **「スクリプト」** ペインを開き、リモート デスクトップ セッション内で実行したのと同じ PowerShell スクリプトを **「myVMPrivate Azure VM」** に貼り付けて実行します。

    >**注**: 今回は、**New-PSDrive : Access is denied**というエラーを受け取ります。 

    >**注**: 仮想マシン *myVmPublic* が public サブネットにデプロイされているため、アクセスが拒否されています。public サブネットには、Azure Storage に対応したサービス エンドポイントがありません。ストレージ アカウントは、private サブネットからのネットワーク アクセスのみ許可します。

1. 次に、**「Windows PowerShell ISE」** のコンソール画面から以下を実行して、仮想マシンがインターネットへの外向きの送信ができるように接続されていることを確認します。 

    ```powershell
    Test-NetConnection -ComputerName www.bing.com -Port 80
    ```

    >**注**: public サブネットに関連付けられているネットワーク セキュリティ グループがないため、テストは成功します。

1. Azure VM **「myVmPublic」** へのリモート デスクトップ セッションを閉じます。

    >**注**: この時点で、パブリック サブネット内の仮想マシンはストレージ アカウントにアクセスできず、インターネットにアクセス可能であることを確認しました。


**リソースをクリーン アップする**

> 新しく作成した Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。 

1. Azure portal の右上にある最初のアイコンをクリックして、Cloud Shell を開きます。メッセージが表示されたら、「**PowerShell**」 と 「**ストレージの作成**」 を選択します。

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。

1. 「クラウド シェル」 ウィンドウ内の 「PowerShell」 セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB12" -Force -AsJob
    ```

1.  「**Cloud Shell**」ペインを閉じます。 
 
