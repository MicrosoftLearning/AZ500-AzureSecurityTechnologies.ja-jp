---
lab:
    title: '11 - Azure SQL データベースのセキュリティ保護'
    module: 'モジュール 03 - データとアプリケーションのセキュリティ保護'
---

# 課題 11: Azure SQL データベースのセキュリティ保護
# 受講生用ラボ マニュアル

## ラボのシナリオ

Azure SQL データベースのセキュリティ機能を確認するように求められました。具体的には、次のことに関心があります。

- SQL インジェクションやデータ流出などの攻撃に対する保護。 
- データベース情報を検出し、機密などのカテゴリに分類する機能。 
- データベース サーバーとデータベース クエリを監査し、イベントをログに記録する機能。 

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: SQL Database のセキュリティ機能を実装する

## ラボ ファイル：

- **\\Allfiles\\Labs\\11\\azuredeploy.json**

### 演習 1: SQL Database のセキュリティ機能を実装する

### 予想時間: 30 分

この演習では、次のタスクを行います。

- タスク 1: Azure SQL データベースのデプロイ
- タスク 2: 高度なデータ保護の構成
- タスク 3: データ分類を構成する
- タスク 4: 監査の構成

#### タスク 1: Azure SQL データベースのデプロイ

このタスクでは、テンプレートを使用してラボ インフラストラクチャを展開します。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注意**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal で Azure portal ページの上部にある **「リソース、サービス、ドキュメントの検索」** テキスト ボックスで、**「カスタム テンプレートのデプロイ」** と入力し、**「Enter」** キーを押します。

1. **カスタム デプロイ** ブレードで、**エディターで独自のテンプレートを作成する** のオプションをクリックします。

1. **「テンプレートの編集」** ブレードで、**「ファイルの読み込み」** をクリックし、**\\Allfiles\\Labs\\11\azuredeploy.json** ファイルを見つけて、**「開く」** をクリックします。

    >**注意**: テンプレートの内容を確認し、Azure SQL データベースをデプロイしていることを確認します。

1. **「テンプレートの編集」** ブレードで、**「保存」** をクリックします。

1. **「カスタム デプロイ」** ブレードで、次の設定が構成されていることを確認します (既定値を使用して他の設定を行います)。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ|**「新規作成」** をクリックして、名前 **AZ500Lab11** を入力します。|
   |リージョン|**米国東部**|

1. 「**確認と作成**」 をクリックし、「**作成**」 をクリックします。

    >**注意**: デプロイが完了するのを待ちます。 

#### タスク 2: 高度なデータ保護の構成

1. Azure portal の、Azure portal ページの上部にある **[ソース、サービス、ドキュメントの検索」** テキスト ボックスで、 **「リソース グループ」**と入力し、**「Enter」** キーを押します。

1. 「**リソース グループ**」 ブレードのリソース グループの一覧で、「**AZ500Lab11**」 エントリをクリックします。

1. **「AZ500Lab11」** ブレードで、新しく作成された SQL サーバーを表すエントリをクリックします。

1. 「SQL Server」ブレードの **「セキュリティ」** セクションで、**「Microsoft Defender for Cloud」** をクリックします。

1. 「**Microsoft Defender for SQL**」で「**Microsoft　Defender for　SQL　を有効にする**」をクリックします。

      >**注意**: Azure Defender for SQL の有効化オプションが表示されるまで待ちます。

1. 「**Microsoft Defender for SQLサーバー レベルで有効にする（構成）**」パラメーターで、**（構成）** をクリックします。   
    
1. 「**サーバー設定**」 ブレードで、価格と試用期間、「**脆弱性評価の設定**」、および 「**Advanced Threat Protection 設定**」 に関する情報を確認します。

1. 「**Microsoft Defender for Cloud**」ブレードに戻り、**推奨事項**と**セキュリティ アラート**を確認します。

      >**注意**: 推奨事項が 「**Microsoft Defender for Cloud**」ブレードに表示されるまでに 10 - 15 分かかる場合があります。完了を待たずに、次のタスクに進み、残りのすべてのタスクを完了してから、このブレードに戻ることも可能です。


#### タスク 3: データ分類を構成する

このタスクでは、GPDR とデータ保護のコンプライアンスに関する SQL Database 内の情報を検出し、分類します。

1. SQL サーバー ブレードの **「設定」** セクションで、**「SQL データベース」** をクリックします。

1. ポリシーの一覧で、 **「AZ500LabDb」** エントリを選択します。 

1. **AZ500LabDb** SQL Database ブレードの **「セキュリティ」** セクションで、**「データの検出と分類」** をクリックします。

1. **「データ検出と分類」** ブレードで、**「分類」** タブをクリックします。

    >**注意**: 分類エンジンは、データベースをスキャンして、機密性が高い可能性のあるデータを含んだ列を探し、推奨される列分類の一覧を提示します。

1. ブレードの上部にある青いバーに表示されたテキスト メッセージ **「分類の推奨事項を備えた 15 列が見つかりました」** をクリックします。

1. リストされた列と推奨される秘密度ラベルを確認します。 

1. **「すべて選択」** チェック ボックスをオンにし、**「選択した推奨事項を受け入れます]** をクリックします。

    >**注意**: または、特定の列だけを選択して他の列を無視することができます。 

    >**注意**: 情報タイプと秘密度ラベルを変更することもできます。 

1. レビューが完了したら、 **「保存」** をクリックします。 

    >**注意**: これで分類が完了し、データベース列に新しい分類メタデータが永続的にラベル付けされます。 

1. 「**データ検出と分類**」 ブレードに戻り、最新の分類情報を考慮して更新されていることを確認してください。 

#### タスク 4: 監査を構成する 

このタスクでは、まずサーバー レベルの監査を構成し、次にデータベース レベルの監査を構成します。 

1. Azure portal で、「SQL Server」 ブレードに戻ります。

1. 「SQL Server」 ブレードの **「セキュリティ」** セクションで、**「監査」** をクリックします。

1. サーバー レベルの監査設定を有効にするには、**「サーバー設定を表示」** をクリックします。

1. 監査を有効にするには、**「Azure SQL 監査の有効化」** スイッチを **「ON」** に設定します。 

1. 「**ストレージ**」 チェックボックスを選択すると、「**サブスクリプション**」 と 「**ストレージ アカウント**」 の入力ボックスが表示されます。

1. ドロップダウン リストから 「**サブスクリプション**」 を選びます。

1. 「**ストレージ アカウント**」 をクリックして、「**新規作成**」 を選択します。

1. **「ストレージ アカウントの作成」** ブレードの **「名前」** ボックスに、小文字と数字を含めた 3 ~ 24 文字のグローバルな一意の名前を入力し、**「OK」** をクリックします。 

1. 「**監査」** ブレードに戻り、**詳細プロパティ**の下で、**保持期間 (日)** を **5** に設定します。 

1. 「監査」ブレードで、**「保存」** をクリックして監査の設定を保存します。 

    >**注**: ストレージ コンテナーのパスが無効な場合、ストレージ アカウントがまだプロビジョニングされていない可能性があります。数分待ってから、**「ストレージ アカウント」** をクリックし、**「ストレージ アカウントの選択」** ブレードで新しく作成したストレージ アカウントを選択し、「監査」 ブレードで **「保存」** をクリックします。

1. サーバー ブレードの **「設定」** セクションで、**「SQL データベース」** をクリックします。

1. ポリシーの一覧で、 **「AZ500LabDb」** エントリを選択します。 

1. **「AZ500LabDb」** SQL データベース」 ブレードの **「セキュリティ」** セクションで、**「監査」** をクリックします。 

    >**注意**: これはデータベース レベルの監査です。サーバー レベルの監査は既に有効になっています。 
  
    >**注意**: 監査は、Azure ストレージ アカウント、Log Analytics ワークスペース、またはイベント ハブに書き込むことができます。これらのオプションは、任意に組み合わせて構成できます。

    >**注意**: サーバーでストレージベースの監査が有効になっている場合、データベースの設定に関係なく、常にデータベースに適用されます。

1. **「監査ログの表示」** をクリックします。

1. **「監査レコード」** ブレードで、サーバー監査とデータベース監査を切り替えることができることに注意してください。 

    >**注意**: この SQL サーバーとデータベースは最近作成されたため、この時点でイベントが利用できることはほとんどありません。 

> 結果: SQL サーバーとデータベースを作成し、データ分類を構成し、監査を行いました。 


**リソースをクリーン アップします**

> Azure リソースのうち、使用しないリソースは必ず削除してください。使用していないリソースを削除することで、予期しないコストが発生しなくなります。 

1. Azure portal から、Azure portal の右上にあるアイコンをクリックして、 Cloud Shell を開きます。メッセージが表示されたら、「**PowerShell**」 と 「**ストレージの作成**」 をクリックします。

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。

1. 「クラウド シェル」 ウィンドウ内の 「PowerShell」 セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB11" -Force -AsJob
    ```
1. **「Cloud Shell」** ウィンドウを閉じます。 
