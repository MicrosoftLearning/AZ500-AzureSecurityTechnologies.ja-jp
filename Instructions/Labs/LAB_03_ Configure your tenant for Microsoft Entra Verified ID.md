---
lab:
  title: 03 - Microsoft Entra Verified ID のためのテナントを構成する
  module: Module 01 - Manage Identity and Access
---
# ラボ 03:Microsoft Entra Verified ID のためのテナントを構成する
# 受講生用ラボ マニュアル

## ラボのシナリオ

# Microsoft Entra 確認済み ID 用にテナントを構成する

>[!Note] 
> Azure Active Directory の検証可能な資格情報が Microsoft Entra 検証済み ID になり、Microsoft Entra 製品ファミリの一部になりました。 ID ソリューションの [Microsoft Entra ファミリ](https://aka.ms/EntraAnnouncement)の詳細を確認し、[統合 Microsoft Entra 管理センター](https://entra.microsoft.com)で作業を開始してください。

Microsoft Entra 確認済み ID は、組織を保護するのに役立つ分散化 ID ソリューションです。 このサービスを使用すると、資格情報を発行して検証できます。 発行者は、確認済み ID サービスを使って、独自にカスタマイズした検証可能な資格情報を発行できます。 検証者は、サービスの無料の REST API を使って、アプリやサービスで検証可能な資格情報を簡単に要求して受け入れることができます。 どちらの場合も、Azure AD テナントは、独自の検証可能な資格情報を発行するか、サード パーティによって発行されたユーザーの検証可能な資格情報の提示を確認するように構成する必要があります。 発行者と検証者の両方である場合は、1 つの Azure AD テナントを使用して、独自の検証可能な資格情報を発行することも、他のユーザーのものを検証することもできます。

このチュートリアルでは、検証可能な資格情報サービスを使うように Azure AD テナントを構成する方法について説明します。

具体的には、次の方法を学習します。

> - Azure Key Vault インスタンスを作成する。
> - 検証済み ID サービスを設定する。
> - アプリケーションを Azure AD に登録する。
> - 分散化識別子 (DID) のドメインの所有権を確認する

次の図は、確認済み ID のアーキテクチャと、構成するコンポーネントです。

![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/8d4d01c2-3110-421a-91a8-7b052bc8d793)


## 前提条件

- 構成するディレクトリのグローバル管理者または認証ポリシー管理者のアクセス許可を持っていることを確認します。 グローバル管理者でない場合は、管理者の同意の付与を含め、アプリの登録を完了するために、アプリケーション管理者のアクセス許可が必要になります。
- Azure Key Vault をデプロイする Azure サブスクリプションまたはリソース グループに対する共同作成者ロールがあることを確認します。

## Key Vault を作成します

Azure Key Vault は、シークレットとキーを安全に保管しアクセスできるようにするクラウド サービスです。 確認済み ID サービスでは、公開キーと秘密キーが Azure Key Vault に格納されます。 これらのキーは、資格情報の署名と検証に使用されます。

### Azure portal を使って Azure キー コンテナーを作成します。

1. ブラウザー セッションを開始し、[Azure portal メニュー](https://portal.azure.com/)にサインインします。
   
2. Azure portal の検索ボックスに、「**キー コンテナー**」と入力します。

3. 結果リストから、"**Key Vault**" を選択します。

4. キー コンテナー セクションで、**[作成]** を選びます。

5. **[キー コンテナーの作成]** の **[基本]** タブで、次の情報を入力するか選びます。
   
   |設定|値|
   |---|---|
   |**プロジェクトの詳細**|
   |サブスクリプション|サブスクリプションを選択します。|
   |Resource group|「**azure-rg-1**」と入力します。 **[OK]** を選択します。|
   |**インスタンスの詳細**|
   |キー コンテナー名|「**Contoso-vault2**」と入力します。|
   |リージョン|**[米国東部]** を選択します。|
   |価格レベル|システムの既定の **[標準]**|
   |削除されたボールトを保持する日数|システムの既定の **[90]**|

6. **[確認および作成]** タブを選ぶか、ページの下部にある青い [確認および作成] ボタンを選びます。
  
7. **［作成］** を選択します

これらの 2 つのプロパティをメモします。

* **Vault Name**:この例では、これは **Contoso-Vault2** です。 この名前は他の手順で使用します。
* **Vault URI (コンテナー URI)**: この例では、コンテナー URI は `https://contoso-vault2.vault.azure.net/` です。 その REST API から資格情報コンテナーを使用するアプリケーションは、この URI を使用する必要があります。

この時点で、使用している Azure アカウントが、この新しいコンテナーで操作を実行することを許可されている唯一のアカウントになります。

>[!NOTE]
>既定では、コンテナーを作成したアカウントのみにアクセス権があります。 確認済み ID サービスはキー コンテナーにアクセスする必要があります。 構成中に使われるアカウントによるキーの作成と削除を許可するアクセス ポリシーを使って、キー コンテナーを構成する必要があります。 構成中に使われるアカウントには、確認済み ID のドメイン バインドを作成できるように、署名のためのアクセス許可も必要です。 テスト中に同じアカウントを使用する場合は、コンテナーの作成者に既定で付与されるアクセス許可のほかに、署名するためのアクセス許可をそのアカウントに付与するように既定のポリシーを変更してください。

### キー コンテナーのアクセス ポリシーを設定する

キー コンテナーには、指定したセキュリティ プリンシパルが Key Vault のシークレットとキーに対して操作を実行できるかどうかを定義します。 確認済み ID サービスの管理者アカウントと、作成した要求サービス API プリンシパルの両方について、キー コンテナーにアクセス ポリシーを設定します。
キー コンテナーを作成すると、検証可能な資格情報によって、メッセージ セキュリティを確保するために使用される一連のキーが生成されます。 これらのキーは、Key Vault に格納されます。 キー セットは、検証可能な資格情報の署名、更新、および回復に使用します。

### 確認済み ID の管理者ユーザーのアクセス ポリシーを設定する

1. [Azure portal](https://portal.azure.com) にサインインします。

2. このチュートリアルで使用するキー コンテナーに移動します。

3. **[設定]** の **[アクセス ポリシー]** を選択します。

4. **[アクセス ポリシーの追加]** の **[ユーザー]** で、このチュートリアルを実行するために使用するアカウントを選択します。

5. **キーのアクセス許可** で、**[取得]**、**[作成]**、**[削除]**、**[署名]** のアクセス許可が選択されていることを確認します。 既定では、 **[作成]** と **[削除]** は既に有効になっています。 更新する必要があるキーのアクセス許可は、 **[署名]** のみです。

      ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/7c8a92ea-24f1-41e6-9656-869e8486af72)


6. 変更を保存するには、 **[保存]** を選択します。

## 確認済み ID を設定する

![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/b4b857a2-24b8-4c3f-9f5c-43d23b58427f)


確認済み ID を設定するには、次の手順のようにします。

1. [Azure portal](https://portal.azure.com) にサインインします。

2. *[確認済み ID]* を検索します。 次に、**[検証済み ID]** を選びます。

3. 左側のメニューから、**[設定]** を選択します。

4. 中央のメニューで、**[Define organization settings] (組織の設定の定義)** を選択します

5. 次の情報を指定して、組織を設定します。

    1. **組織名**: 検証済み ID で自分のビジネスを参照する名前を入力します。 顧客にこの名前は表示されません。

    1. **信頼される側のドメイン**: 分散化 ID (DID) ドキュメントのサービス エンドポイントに追加されるドメインを入力します。 ドメインは、ユーザーがお客様のビジネスについて知っている具体的な何かに DID をバインドするものです。 Microsoft Authenticator とその他のデジタル ウォレットでは、DID がドメインにリンクされていることを検証するために、この情報を使用します。 DID を検証できる場合、ウォレットには検証済み記号が表示されます。 ウォレットで DID を検証できない場合、検証できない資格情報が組織によって発行されたことがユーザーに通知されます。

        >[!IMPORTANT]
        > ドメインはリダイレクトしないようにします。 そうしないと、DID とドメインはリンクできません。 ドメインに HTTPS を使用してください。 (例: `https://did.woodgrove.com`)。

    1. **キー コンテナー**: 前に作成したキー コンテナーを選択します。

    1. **[詳細設定]** で、テナントに使用する**信頼システム**を選択できます。 **[Web]** または **[ION]** のいずれかを選択できます。 Web の場合、テナントで [did:web](https://w3c-ccg.github.io/did-method-web/) が did メソッドとして使用され、ION の場合 [did:ion](https://identity.foundation/ion/) が使用されることを意味します。

        >[!IMPORTANT]
        > 信頼システムを変更する唯一の方法は、検証済み ID サービスをオプトアウトし、オンボードを再実行することです。

1. **[保存]** を選択します。  

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/b191676e-03e3-423f-aa28-1e3d2887ea07)


### 検証済み ID のサービス プリンシパルに対するアクセス ポリシーを設定する

前の手順で検証済み ID を設定すると、Azure Key Vault のアクセス ポリシーが自動的に更新され、検証済み ID のサービス プリンシパルに必要なアクセス許可が付与されます。  
アクセス許可を手動でリセットする必要がある場合、アクセス ポリシーは次のようになります。

| サービス プリンシパル | AppId | キーのアクセス許可 |
| -------- | -------- | -------- |
| 検証可能な資格情報サービス | bb2a64ee-5d29-4b07-a491-25806dc854d3 | 取得、署名 |
| 検証可能な資格情報のサービス要求 | 3db474b9-6a0c-4840-96ac-1fceb342124f | 署名 |



![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/896b8ea0-b88b-43b8-a93b-4771defedfde)


## アプリケーションを Azure AD に登録する

アプリケーションは、資格情報を発行または検証できるように Microsoft Entra 確認済み ID を呼び出す必要があるときに、アクセス トークンを取得する必要があります。 アクセス トークンを取得するには、アプリケーションを登録し、確認済み ID 要求サービスに対する API アクセス許可を付与する必要があります。 たとえば、Web アプリケーションには次の手順を使用します。

1. 管理者アカウントで [Azure portal](https://portal.azure.com) にサインインします。

1. 複数のテナントにアクセスできる場合は、**[ディレクトリ + サブスクリプション]** を選択します。 次に、お使いの **Azure Active Directory** を探して選択します。

1. **[管理]** で **[アプリの登録]** > **[新規登録]** の順に選択します。  

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/03ca3d13-5564-4ce2-b42c-f8333bc97fb5)


1. アプリケーションの表示名を入力します。 たとえば、*verifiable-credentials-app* と指定します。

1. **[サポートされているアカウントの種類]** で、 **[Accounts in this organizational directory only (Default Directory only - Single tenant)](この組織ディレクトリのアカウントのみ (既定のディレクトリのみ - シングル テナント))** を選択します。

1. **[登録]** を選択して、アプリケーションを作成します。

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/d0a15737-c8a9-4522-990d-1cf6bc12cc1e)


### アクセス トークンを取得するためにアクセス許可を付与する

この手順では、**検証可能な資格情報サービス要求**のサービス プリンシパルにアクセス許可を付与します。

必要なアクセス許可を追加するには、次の手順に従います。

1. **verifiable-credentials-app** アプリケーション詳細ページで作業を続けます。 **[API のアクセス許可]** 、 **[アクセス許可の追加]** の順に選択します。

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/adf97022-2081-4273-8d61-f2b53628e989)

1. **[所属する組織で使用している API]** を選択します。

1. **検証可能な資格情報サービス要求**サービス プリンシパルを検索し、選択します。

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/01691eb2-ab7f-4778-9911-342eb9350f99)

1. **[アプリケーションのアクセス許可]** を選択し、 **[VerifiableCredential.Create.All]** を展開します。

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/3c5e008e-2ba5-417a-90ff-22e8f622ad34)


1. **アクセス許可の追加** を選択します。

1. **[\<your tenant name\> に管理者の同意を与えます]** を選択します。

範囲を異なるアプリケーションに分離する場合、発行とプレゼンテーションのアクセス許可を別々に付与することを選択できます。

![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/640def45-e666-423e-bf69-598e8980b125)

## 分散化 ID を登録してドメインの所有権を確認する

Azure Key Vault がセットアップされ、サービスに署名キーが設定されたら、セットアップの手順 2 と 3 を完了する必要があります。

![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/40e10177-b025-4d10-b16a-d66c06762c3f)

1. Azure portal で確認済み ID サービスに移動します。  
1. 左側のメニューから、**[設定]** を選択します。
1. 中央のメニューから、**[ドメインの所有権を確認します]** を選びます。

# 分散化識別子 (DID) のドメインの所有権を確認する

## ドメインの所有権を確認し、did-configuration.json ファイルを配布する

ドメインは、コントロールの下のドメインである必要があり、形式は `https://www.example.com/` である必要があります。 

1. Azure portal から確認済み ID のページに移動します。

1. **[セットアップ]**、**[ドメイン所有権の確認]** の順に選択し、ドメインの **[確認]** を選択します。

1. `did-configuration.json` ファイルをコピーまたはダウンロードします。

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/342fa12f-2d0d-40cf-a2f9-8796a86f0824)

1. 指定した場所で `did-configuration.json` ファイルをホストします。 例: ドメイン `https://www.example.com` を指定した場合、この URL `https://www.example.com/.well-known/did-configuration.json` でファイルをホストする必要があります。
   `.well-known path` 名以外の追加のパスを URL に指定することはできません。

1. `did-configuration.json` が .well-known/did-configuration.json URL で公開されている場合は、**[検証状態の更新]** ボタンを押して確認します。

   ![画像](https://github.com/MicrosoftLearning/AZ500-AzureSecurityTechnologies/assets/91347931/49a06251-af56-49b2-9059-0bd4ca678da6)

> 結果:Azure Key Vault インスタンスの作成、検証済み ID サービスの設定、Azure AD へのアプリケーションの登録、分散化識別子 (DID) のドメイン所有権の検証が正常に完了します。

**リソースのクリーンアップ**

> 新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しないコストが発生しなくなります。 
