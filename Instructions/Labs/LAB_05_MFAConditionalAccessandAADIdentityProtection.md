---
lab:
  title: 04 - MFA および条件付きアクセス
  module: Module 01 - Manage Identity and Access
---

# ラボ 05:MFA および条件付きアクセス
# 受講生用ラボ マニュアル

## ラボのシナリオ

Azure Active Directory (Azure AD) 認証を強化する機能の概念実証を作成するように求められました。 具体的には、以下を評価する必要があります。

- Azure AD Multi-Factor Authentication
- Azure AD 条件付きアクセス
- Azure AD 条件付きアクセスのリスクベースのポリシー

> このラボのすべてのリソースについて、**米国東部**リージョンを使用しています。 これがクラスで使用するリージョンであることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1:Azure Resource Manager テンプレートを使用して Azure VM をデプロイします
- 演習 2:Azure MFA を実装する
- 演習 3:Azure AD 条件付きアクセス ポリシーを実装する 
- 演習 4:Azure AD Identity Protection を実装する

## MFA - 条件付きアクセス - Identity Protection の図

![image](https://user-images.githubusercontent.com/91347931/157518628-8b4a9efe-0086-4ec0-825e-3d062748fa63.png)

## Instructions

## ラボ ファイル：

- **\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.json**
- **\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.parameters.json** 

### 演習 1:Azure Resource Manager テンプレートを使用して Azure VM をデプロイします

### 推定時間:10 分

この演習では、次のタスクを実行します。

- タスク 1:Azure Resource Manager テンプレートを使用して Azure VM をデプロイします。

#### タスク 1:Azure Resource Manager テンプレートを使用して Azure VM をデプロイします

このタスクでは、ARM テンプレートを使用して仮想マシンを作成します。 この仮想マシンは、このラボの最後の演習で使用されます。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**:このラボで使用している Azure サブスクリプションの所有者または共同作成者のロールと、そのサブスクリプションに関連付けられている Azure AD テナントのグローバル管理者の役割を持つアカウントを使用して、Azure portal にサインインします。

2. Azure portal で Azure portal ページの上部にある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで、「**カスタム テンプレートをデプロイする**」と入力します。

    >**注**: **[マーケットプレイス]** リストから**テンプレートのデプロイ (カスタム テンプレートを使用してデプロイ)** を選択することも可能です。

3. **[カスタム デプロイ]** ブレードで、**[エディターで独自のテンプレートをビルド]** のオプションをクリックします。

4. **[テンプレートの編集]** ブレードで、**[ファイルの読み込み]** をクリックし、**\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.json** ファイルを見つけて、**[開く]** をクリックします。

    >**注**:テンプレートの内容を確認し、Windows Server 2019 の Datacenter をホストする Azure VM をデプロイしていることを確認してください。

5. **[テンプレートの編集]** ブレードで、**[保存]** をクリックします。

6. **[カスタム デプロイ]** ブレードに戻って、**[パラメーターの編集]** をクリックします。

7. **[パラメーターの編集]** ブレードで、**[ファイルの読み込み]** をクリックし、**\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.parameters.json** ファイルを見つけて、**[開く]** をクリックします。

    >**注**:パラメーター ファイルの内容を確認し、adminUsername 値と adminPassword 値を示します。

8. **[パラメーターの編集]** ブレードで、**[保存]** をクリックします。

9. **[カスタム デプロイ]** ブレードで、次の設定が構成されていることを確認します (既定値を使用して他の設定を行います)。

   >**注**:このコースの残りの部分で VM (仮想マシン) の作成に使用される一意のパスワードを作成する必要があります。 パスワードは 12 文字以上で、定義された複雑さの要件を満たす必要があります (パスワードには次のうち 3 つを含める必要があります:小文字 1 個、大文字 1 個、数字 1 個、特殊文字 1 個)。 [VM パスワードの要件](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/faq#what-are-the-password-requirements-when-creating-a-vm-)。 パスワードをメモしておいてください。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ|**[新規作成]** をクリックして、「**AZ500LAB04**」という名前を入力します|
   |場所|**米国東部**|
   |VM サイズ|**Standard_D2s_v3**|
   |VM 名|**az500-04-vm1**|
   |管理ユーザー名|**Student**|
   |管理パスワード|**独自のパスワードを作成し、後で参照するために記録してください。必要なラボ アクセス用にこのパスワードの入力を求められます。**|
   |仮想ネットワーク名|**az500-04-vnet1**|

   >**注**:Azure VM をプロビジョニングできる Azure リージョンを特定するには、[ **https://azure.microsoft.com/en-us/regions/offers/** ](https://azure.microsoft.com/en-us/regions/offers/) を参照してください

10. **[確認と作成]** をクリックし、**[作成]** をクリックします。

    >**注**:デプロイメントが完了するのを待たず、次のエクササイズに進みます。 このラボの最後の演習では、このデプロイに含まれる仮想マシンを使用します。

> 結果:このラボの最後の演習で使用する Azure VM **az500-04-vm1** のテンプレートのデプロイを開始しました。


### 演習 2:Azure MFA を実装する

### 推定時間:30 分

この演習では、次のタスクを実行します。

- タスク 1:新しい Azure AD テナントを作成します。
- タスク 2:Azure AD Premium P2 試用版をアクティブにします。
- タスク 3:Azure AD ユーザーとグループを作成します。
- タスク 4:Azure AD ユーザーに Azure AD Premium P2 ライセンスを割り当てます。
- タスク 5:Azure MFA 設定を構成します。
- タスク 6:MFA 構成を検証する

#### タスク 1:新しい Azure AD テナントを作成

このタスクでは、新しい Azure AD テナントを作成します。 

1. Azure portal の **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで、Azure portal ページの上部に「**Azure Active Directory**」と入力し、**Enter** キーを押します。

2. 現在の Azure AD テナントの **[概要]** を表示しているブレードで、 **[テナントの管理]** をクリックし、次の画面で **[+ 作成]** をクリックします。

3. **テナントの作成** ブレードの **基本** タブで、オプション **Azure Active Directory** が選択されていることを確認し、**次へ:構成 >** をクリックします。

4. **[Create a tenant](テナントの作成)** ブレードの **[構成]** タブで、次の設定を指定します。

   |設定|値|
   |---|---|
   |組織名|**AdatumLab500-04**|
   |初期ドメイン名|文字と数字の組み合わせから成る一意の名前|
   |国/リージョン|**米国**|

    >**注**:初期ドメイン名を記録します。 このラボで後ほど必要になります。

5. **[確認と作成]** をクリックしてから、**[作成]** をクリックします。
6. **[ロボットではないことを証明します]** ブレードにキャプチャ コードを追加し、**[送信]** ボタンをクリックします。 

    >**注**:新しいテナントが作成されるのを待ちます。 **通知** アイコンを使用して、デプロイ ステータスを監視します。 


#### タスク 2:Azure AD Premium P2 試用版のアクティブ化

このタスクでは、Azure AD Premium P2 無料試用版にサインアップします。 

1. Azure portal のツール バーで、Cloud Shell アイコンの右側にある **[ディレクトリとサブスクリプション]** アイコンをクリックします。 

2. **[Directory + subscription]** ブレードで、新しく作成したテナント、**AdatumLab500-04** をクリックし、**切り替え**ボタンをクリックして現在のディレクトリとして設定します。

    >**注**:**AdatumLab500-04** エントリが **Directory + Subscription** のフィルター リストに表示されない場合は、ブラウザーの画面を更新する必要があります。

3. Azure portal の **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで、Azure portal ページの上部に「**Azure Active Directory**」と入力し、**Enter** キーを押します。 **[AdatumLab500-04]** ブレードの **[管理]** セクションで、**[ライセンス]** をクリックします。

4. **[ライセンス \| 概要]** ブレードの **[管理]** セクションで、**[すべての製品]** をクリックし、**[+ 試す/購入]** をクリックします。

5. **[アクティブ化]** ブレードの [Azure AD Premium P2] セクションで、**[無料試用版]** をクリックし、**[アクティブ化]** をクリックします。


#### タスク 3:Azure AD ユーザーとグループを作成します。

このタスクでは、aaduser1 (グローバル管理者)、aaduser2 (ユーザー)、および aaduser3 (ユーザー) の 3 つのユーザーを作成します。 後のタスクには、各ユーザーのユーザー プリンシパル名とパスワードが必要です。 

1. **[AdatumLab500-04** Azure Active Directory] ブレードに戻り、**[管理]** セクションで **[ユーザー]** をクリックします。

2. **[ユーザー \| すべてのユーザー]** ブレードで、**[+ 新しいユーザー]**、**[新しいユーザーの作成]** を順にクリックします。 

3. **[新しいユーザー]** ブレードで、**[ユーザーの作成]** オプションが選択されていることを確認し、[基本] タブで以下の設定を指定して (その他の設定はすべて既定値のままにします)、**[次へ: プロパティ >]** をクリックします。

   |設定|値|
   |---|---|
   |ユーザー プリンシパル名|**aaduser1**|
   |名前|**aaduser1**|
   |Password|**[パスワードの自動生成]** オプションが選択されていることを確認します|
   
      >**注**:完全なユーザー プリンシパル名を記録します。 ドメイン名が表示されているドロップダウン リストの右側にある **[クリップボードにコピー]** ボタンをクリックすると、値をコピーできます。 これは、このラボの後半で必要になります。
   
      >**注**:ユーザーのパスワードを記録します。 テキスト ボックスの右側にある **[クリップボードにコピー]** ボタンをクリックすると、値をコピーできます。 これは、このラボの後半で必要になります。 
   
4. **[プロパティ]** タブで一番下までスクロールし、[利用場所] を指定します。**[米国]** を指定して (その他の設定はすべて既定値のままにします)、**[次へ: 割り当て >]** を選択します。

5. **[割り当て]** タブで、**[+ ロールの追加]** をクリックし、**[全体管理者]** を検索して選択します。 **[選択]**、**[確認 + 作成]**、**[作成]** の順にクリックします。

6. **[ユーザー \| すべてのユーザー]** ブレードに戻り、**[+ 新しいユーザー]** をクリックします。 

7. **[新しいユーザー]** ブレードで、**[ユーザーの作成]** オプションが選択されていることを確認し、次の設定を指定し (その他の設定はすべて既定値のままにします)、**[次へ: プロパティ >]** をクリックします。

   |設定|値|
   |---|---|
   |ユーザー プリンシパル名|**aaduser2**|
   |名前|**aaduser2**|
   |Password|**[パスワードの自動生成]** オプションが選択されていることを確認します| 

    >**注**:完全なユーザー プリンシパル名とパスワードを記録します。

8. **[プロパティ]** タブで一番下までスクロールし、[利用場所] を指定します。**[米国]** を指定して (その他の設定はすべて既定値のままにします)、**[確認 + 作成]**、**[作成]** の順にクリックします。

9. **[ユーザー \| すべてのユーザー]** ブレードに戻り、**[+ 新しいユーザー]** をクリックします。 

10. **[新しいユーザー]** ブレードで、**[ユーザーの作成]** オプションが選択されていることを確認し、次の設定を指定し (その他の設定はすべて既定値のままにします)、**[次へ: プロパティ >]** をクリックします。

    |設定|値|
    |---|---|
    |ユーザー プリンシパル名|**aaduser3**|
    |名前|**aaduser3**|
    |Password|**[パスワードの自動生成]** オプションが選択されていることを確認します|

    >**注**:完全なユーザー プリンシパル名とパスワードを記録します。

11. **[プロパティ]** タブで一番下までスクロールし、[利用場所] を指定します。**[米国]** を指定して (その他の設定はすべて既定値のままにします)、**[確認 + 作成]**、**[作成]** の順にクリックします。

    >**注**: この時点で、**[ユーザー]** ページに 3 人の新しいユーザーが表示されます。 
    
#### タスク 4:Azure AD ユーザーに Azure AD Premium P2 ライセンスを割り当てる

このタスクでは、各ユーザーを Azure Active Directory Premium P2 ライセンスに割り当てます。

1. **[ユーザー \| すべてのユーザー]** ブレードで、ユーザー アカウントを表すエントリをクリックします。 

2. ユーザー アカウントのプロパティを表示するブレードで、 **[プロパティの編集]** をクリックします。  [利用場所] が **[米国]** に設定されていることを確認します。 そうでない場合は、利用場所を設定し、**[保存]** をクリックします。

3. **[AdatumLab500-04** Azure Active Directory] ブレードに戻り、**[管理]** セクションで **[ライセンス]** をクリックします。

4. **[ライセンス \| 概要]** ブレードで、**[すべての製品]** をクリックし、**[Azure Active Directory Premium P2]** チェックボックスをオンにして、**[+ 割り当て]** をクリックします。

5. **[ライセンスの割り当て]** ブレードで、 **[+ ユーザーとグループの追加]** をクリックします。

6. **[ユーザー]** ブレードで、**aaduser1**、**aaduser2**、**aaduser3**、ユーザー アカウントを選択し、**[選択]** をクリックします。

7. **[ライセンスの割り当て]** ブレードに戻り、**[割り当てオプション]** をクリックし、すべてのオプションが有効になっていることを確認して、**[レビューと割り当て]** をクリックし、次に **[割り当て]** をクリックします。

8. Azure portal からサインアウトし、同じアカウントを使用して再びサインインします。 (ライセンスの割り当てを有効にするためには、この手順が必要です。)

    >**注**:この時点で、このラボで使用するすべてのユーザー アカウントに Azure Active Directory Premium P2 ライセンスを割り当ててください。 必ずサインアウトしてから、再度サインインしてください。 

#### タスク 5:Azure MFA 設定を構成します。

このタスクでは、MFA を構成し、aaduser1 の MFA を有効にします。 

1. Azure portal で、**[AdatumLab500-04]** Azure Active Directory テナント ブレードに移動します。

    >**注**:AdatumLab500-04 Azure AD テナントを使用していることを確認します。

2. **AdatumLab500-04** Azure Active Directory テナント ブレードの **[管理]** セクションで、**[セキュリティ]** をクリックします。

3. **[セキュリティ \| 作業の開始]** ブレードの **[管理]** セクションで、 **[多要素認証]** をクリックします。

4. **[多要素認証 \| 作業の開始]** ブレードで、 **[クラウドベースの多要素認証の追加設定]** リンクをクリックします。 

    >**注**: 新しいブラウザー タブが開き、 **[多要素認証]** ページが表示されます。

5. **[多要素認証]** ページで、 **[サービスの設定]** タブをクリックします。 **[検証オプション]** を確認します。 **[電話へのテキスト メッセージ]**、**[モバイル アプリによる通知]**、**[モバイル アプリまたはハードウェア トークンからの確認コード]** が有効になっていることに注意してください。 **[保存]** をクリックしてから、**[閉じる]** をクリックします。

6. **[ユーザー]** タブに切り替えて、**[aaduser1]** エントリをクリックし、**[有効]** リンクをクリックします。プロンプトが表示されたら、**[多要素認証を有効にする]** をクリックし、次に **[閉じる]** をクリックします。

7. **aaduser1** の **[多要素認証の状態]** 列が **[有効]** になったことに注目してください。

8. **aaduser1** をクリックすると、この時点で **[強制]** オプションも表示されます。 

    >**注**: ユーザーの状態を [有効] から[強制] に変更すると、Azure MFA をサポートしない従来の Azure AD 統合アプリのみが影響を受け、状態が [強制] に変更されるとアプリ パスワードの使用が要求されます。

9. **aaduser1** エントリを選択した状態で、**[ユーザー設定の管理]** をクリックし、使用可能なオプションを確認します。 

   - [選択されたユーザーに連絡方法を再び提供するように要求する]。

   - [選択されたユーザーによって生成された既存のアプリ パスワードをすべて削除する]。

   - 記憶されているすべてのデバイスで多要素認証を復元します。

10. **[キャンセル]** をクリックし、Azure portal の **[多要素認証 \| はじめに]** ブレードが表示されているブラウザー タブに戻ります。

11. **[設定]** セクションで、**[不正アクセスのアラート]** をクリックします。

12. **[多要素認証 \| 不正アクセスのアラート]** ブレードで、次の設定を構成します。

    |設定|値|
    |---|---|
    |ユーザーに不正アクセス アラートの送信を許可する|**オン**|
    |不正を報告するユーザーを自動的にブロックする|**オン**|
    |最初の挨拶中に不正を報告するコード|**0**|

13. **[保存]**

    >**注**:この時点で、aaduser1 の MFA を有効にし、不正アクセスのアラートの設定を構成しました。 

14. **AdatumLab500-04** Azure Active Directory テナント ブレードに戻り、**[管理]** セクションで **[プロパティ]** をクリックし、次にブレードの下部にある **[セキュリティの既定値群の管理]** リンクをクリックします。**[セキュリティの既定値の有効化]** ブレードで **[無効]** をクリックします。 **[自分の組織では条件付きアクセスを使用している]** を *[無効にする理由]* として選択し、**[保存]** をクリックして警告を読み、**[無効にする]** をクリックします。

    >**注**:**AdatumLab500-04** Azure AD テナントにサインインしていることを確認します。 **Directory + subscription** フィルターを使用して、Azure AD テナント間で切り替えることができます。 Azure AD テナントでグローバル管理者の役割を持つユーザーとしてサインインしていることを確認します。

#### タスク 6:MFA 構成を検証する

このタスクでは、aaduser1 ユーザー アカウントのサインインをテストして MFA 構成を検証します。 

1. InPrivate ブラウザー ウィンドウを開きます。

2. Azure portal (**`https://portal.azure.com/`**) に移動し、**aaduser1** のユーザー アカウントを使用してサインインします。 

    >**注**:サインインするには、このラボで前に記録した Azure AD テナントの DNS ドメイン名を含む、**aaduser1** ユーザー アカウントの完全修飾名を指定する必要があります。 このユーザー名の形式は、aaduser1@`<your_tenant_name>`.onmicrosoft.com です。`<your_tenant_name>` は、一意の Azure AD テナント名を表すプレースホルダーです。 

3. メッセージが表示されたら、**[詳細情報が必要]** ダイアログ ボックスで **[次へ]** をクリックします。

    >**注**: ブラウザー セッションは、**[追加のセキュリティ検証]** ページにリダイレクトされます。

4. **[アカウントを安全に保つ]** ページで、**[別の方法を設定しする]** リンクを選択し、**[どの方法を使用しますか?]** ドロップダウン リストで **[電話]** を選択し、**[確認]** を選択します。

5. **[アカウントを安全に保つ]** ページで、国または地域を選択し、**[電話番号を入力する]** 領域に携帯電話番号を入力し、**[コードをテキストメッセージで送信する]** オプションが選択されていることを確認して、**[次へ]** をクリックします。
 
6. **[アカウントを安全に保つ]** ページで、携帯電話のテキスト メッセージで受信したコードを入力し、**[次へ]** をクリックします。

7. **[アカウントを安全に保つ]** ページで、確認が成功したことを確認し、**[次へ]** をクリックします。

8. 追加の認証方法を求められたら、**[別の方法を設定します]** をクリックし、ドロップダウン リストから **[メール]** を選択します。**[確定]** をクリックし、使用するメール アドレスを入力して **[次へ]** をクリックします。 メールが届いたら、メール本文に記載されているコードを確認して入力し、**[完了]** をクリックします。

9. パスワードの変更を求められたら、変更します。 新しいパスワードを必ず記録してください。

10. Azure portal に正常にサインインしたことを確認します。

11. **aaduser1** としてサインアウトし、InPrivate ブラウザーの画面を閉じます。

> 結果:新しい AD テナントを作成し、AD ユーザーを構成し、MFA を構成し、ユーザーの MFA エクスペリエンスをテストしました。 


### 演習 3:Azure AD 条件付きアクセス ポリシーを実装する 

### 推定時間:15 分

この演習では、次のタスクを実行します。 

- タスク 1:条件付きアクセス ポリシーを構成します。
- タスク 2:条件付きアクセス ポリシーをテストします。

#### タスク 1 - 条件付きアクセス ポリシーを構成します。 

このタスクでは、条件付きアクセス ポリシー設定を確認し、Azure portal にサインインするときに MFA を必要とするポリシーを作成します。 

1. Azure portal で、**[AdatumLab500-04]** Azure Active Directory テナント ブレードに移動します。

2. **[AdatumLab500-04]** ブレードの **[管理]** セクションで、**[セキュリティ]** をクリックします。

3. **[セキュリティ \| はじめに]** ブレードの **[保護]** セクションで、**[条件付きアクセス]** をクリックします。 左側のナビゲーション パネルで、**[ポリシー]** をクリックします。

4. **[条件付きアクセス \| ポリシー]** ブレードで、**[+ 新しいポリシー]** をクリックします。 

5. **新規**のブレードで、次の設定を構成します。

   - **[名前]** テキスト ボックスに「**AZ500Policy1**」と入力します
    
   - **[ユーザー]** で **[0 人のユーザーとグループが選択されました]** をクリックします。 [含める] の右側で、**[ユーザーとグループの選択]** を有効にします >> **[ユーザーとグループ]** チェックボックスをオンにして、**[ユーザーとグループの選択]** ブレードで、**[aaduser2]** チェックボックスをオンにし、**[選択]** をクリックします。
    
   - **[ターゲット リソース]** で、**[ターゲット リソースが選択されていません]** をクリックし、**[アプリの選択]** をクリックして、[選択] の下にある **[なし]** をクリックします。 **[選択]** ブレードで、**[Microsoft Azure の管理]** のチェックボックスをオンにしてから、**[選択]** をクリックします。 

     >**注**:このポリシーが Azure portal へのアクセスに影響を与えるという警告を確認します。
    
   - **[条件]** で、**[0 個の条件が選択されました]** をクリックし、**[サインイン リスク]** で **[未構成]** をクリックします。 **[サインイン リスク]** ブレードで、リスク レベルを確認しますが変更は加えず、**[サインイン リスク]** ブレードを閉じます。
    
   - **[デバイス プラットフォーム]** の **[未構成]** をクリックし、含めることができるデバイス プラットフォームを確認しますが変更は加えず、**[完了]** をクリックします。
    
   - **[場所]** で、**[未構成]** をクリックし、変更を加えずに場所のオプションを確認します。
    
   - **[許可]** の下の **[アクセス制御]** セクションで、**[0 個のコントロールが選択されました]** をクリックします。 **[許可]** ブレードで、**[多要素認証が必要]** チェックボックスをオンにして、**[選択]** をクリックします
    
   - **[ポリシーの有効化]** を **[オン]** に設定します

6. **[新規]** ブレードで **[作成]** をクリックします。 

    >**注**:この時点で、条件付きアクセス ポリシーを使用して、MFA が Azure portal にサインインする必要があります。 

#### タスク 2 - 条件付きアクセス ポリシーをテストします。

このタスクでは、Azure portal に **aaduser2** としてサインインし、MFA が必要であることを確認します。 また、次の演習に進む前に、ポリシーを削除します。 

1. InPrivate Microsoft Edge ウィンドウを開きます。

2. 新しいブラウザー ウィンドウで、Azure portal (**`https://portal.azure.com/`**) に移動し、**aaduser2** ユーザー アカウントでサインインします。

3. メッセージが表示されたら、**[詳細情報が必要]** ダイアログ ボックスで **[次へ]** をクリックします。

    >**注**:ブラウザー セッションは、**[アカウントのセキュリティ保護]** ページにリダイレクトされます。
    
4. **[アカウントを安全に保つ]** ページで、**[別の方法を設定しする]** リンクを選択し、**[どの方法を使用しますか?]** ドロップダウン リストで **[電話]** を選択し、**[確認]** を選択します。

5. **[アカウントを安全に保つ]** ページで、国または地域を選択し、**[電話番号を入力する]** 領域に携帯電話番号を入力し、**[コードをテキストメッセージで送信する]** オプションが選択されていることを確認して、**[次へ]** をクリックします。

6. **[アカウントを安全に保つ]** ページで、携帯電話のテキスト メッセージで受信したコードを入力し、**[次へ]** をクリックします。

7. **[アカウントを安全に保つ]** ページで、確認が成功したことを確認し、**[次へ]** をクリックします。

8. **[アカウントのセキュリティ保護]** ページで、**[完了]** をクリックします。

9. パスワードの変更を求められたら、変更します。 新しいパスワードを必ず記録してください。

10. Azure portal に正常にサインインしたことを確認します。

11. **aaduser2** としてサインアウトし、InPrivate ブラウザー ウィンドウを閉じます。

    >**注**:aaduser2 が Azure portal にサインインするときに、新しく作成された条件付きアクセスポリシーが MFA を適用することを確認しました。

12. Azure portal を表示しているブラウザーの画面に戻り、**[AdatumLab500-04** Azure Active Directory テナント] ブレードに戻ります。

13. **[AdatumLab500-04]** ブレードの **[管理]** セクションで、**[セキュリティ]** をクリックします。

14. **[セキュリティ \| はじめに]** ブレードの **[保護]** セクションで、**[条件付きアクセス]** をクリックします。 左側のナビゲーション パネルで、**[ポリシー]** をクリックします。

15. **[条件付きアクセス \| ポリシー]** ブレードで、**[AZ500Policy1]** の横にある省略記号をクリックして **[削除]** をクリックし、確認を求められたら **[はい]** をクリックします。

    >**注**:結果:この演習では、条件付きアクセスポリシーを導入して、ユーザーが Azure portal にサインインするときに MFA を要求します。 

>結果:Azure AD の条件付きアクセスを構成してテストしました。

### 演習 4: 条件付きアクセスでリスクベースのポリシーを展開する

### 推定時間:30 分

この演習では、次のタスクを実行します。

- タスク 1:Azure portal で Azure AD ID 保護オプションを表示する
- タスク 2:ユーザー リスク ポリシーを構成する
- タスク 3:サインイン リスク ポリシーを構成する
- タスク 4:Azure AD Identity Protection ポリシーに対するリスク イベントのシミュレーション 
- タスク 5:Azure AD Identity Protection レポートを確認する

#### タスク 1:Azure AD Identity Protection を有効化する

このタスクでは、Azure portal で Azure AD Identity Protection オプションを表示します。 

1. 必要に応じて、Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**:**AdatumLab500-04** Azure AD テナントにサインインしていることを確認します。 **Directory + subscription** フィルターを使用して、Azure AD テナント間で切り替えることができます。 Azure AD テナントでグローバル管理者の役割を持つユーザーとしてサインインしていることを確認します。

#### タスク 2:ユーザー リスク ポリシーを構成する

このタスクでは、ユーザー リスク ポリシーを作成します。 

1. **[AdatumLab500-04]** Azure AD テナント > **[セキュリティ]** > **[条件付きアクセス]** > **[ポリシー]** に移動します。

2. **[+ 新しいポリシー]** をクリックします。

3. **[名前]** テキスト ボックスにポリシー名「**AZ500Policy2**」を入力します。

4. **[割り当て]** > **[ユーザー]** で、**[0 人のユーザーとグループが選択されました]** をクリックします。

5. **[含める]** で、**[ユーザーとグループの選択]** をクリックし、**[ユーザーとグループ]** をクリックして、**aaduser2** と **aaduser3** を選択し、**[選択]** をクリックします。

6. **[除外]** で、**[ユーザーとグループ]** をクリックし、**aaduser1** を選択したら、**[選択]** をクリックします。 

7. **[ターゲット リソース]** で、**[ターゲット リソースが選択されていません]** をクリックし、ドロップダウンで **[クラウド アプリ]** が選択されていることを確認して、**[含める]** で **[すべてのクラウド アプリ]** を選択します。

8. **[条件]** で、**[0 個の条件が選択されました]** をクリックし、**[ユーザー リスク]** で **[未構成]** をクリックします。 **[ユーザー リスク]** ブレードで、**[構成]** を **[はい]** に設定します。

9. **[ポリシーを適用するために必要なユーザー リスク レベルを構成する]** で、**[高]** を選びます。

10. **[Done]** をクリックします。

11. **[許可]** の下の **[アクセス制御]** セクションで、**[0 個のコントロールが選択されました]** をクリックします。 **[許可]** ブレードで、**[アクセス権の付与]** が選択されていることを確認します。

12. **[多要素認証を要求する]** と **[パスワードの変更を必須とする]** を選択します。

13. **[選択]** をクリックします。

14. **[セッション]** で、**[0 個のコントロールが選択されました]** をクリックします。 **[サインイン頻度]** を選択し、次に **[毎回]** を選択します。

15. **[選択]** をクリックします。

16. **[ポリシーの有効化]** が **[レポートのみ]** に設定されていることを確認します。

17. **[作成]** をクリックして、ポリシーを有効化します。

#### タスク 3:サインイン リスク ポリシーを構成する

1. **[AdatumLab500-04]** Azure AD テナント > **[セキュリティ]** > **[条件付きアクセス]**> **[ポリシー]** に移動します。

2. **[新しいポリシー]** を選択します。

3. **[名前]** テキスト ボックスにポリシー名「**AZ500Policy3**」を入力します。

4. **[割り当て]** > **[ユーザー]** で、**[0 人のユーザーとグループが選択されました]** をクリックします。

5. **[含める]** で、**[ユーザーとグループの選択]** をクリックし、**[ユーザーとグループ]** をクリックして、**aaduser2** と **aaduser3** を選択し、**[選択]** をクリックします。

6. **[除外]** で、**[ユーザーとグループ]** をクリックし、**aaduser1** を選択して、**[選択]** をクリックします。 

7. **[ターゲット リソース]** で、**[ターゲット リソースが選択されていません]** をクリックし、ドロップダウンで **[クラウド アプリ]** が選択されていることを確認して、**[含める]** で **[すべてのクラウド アプリ]** を選択します。

8. **[条件]** で、**[0 個の条件が選択されました]** をクリックし、**[サインイン リスク]** で **[未構成]** をクリックします。 **[サインイン リスク]** ブレードで、**[構成]** を **[はい]** に設定します。

9. **[このポリシーを適用するサインイン リスク レベルを選択します]** で、 **[高]** と **[中]** を選択します。

10. **[Done]** をクリックします。

11. **[許可]** の下の **[アクセス制御]** セクションで、**[0 個のコントロールが選択されました]** をクリックします。 **[許可]** ブレードで、**[アクセス権の付与]** が選択されていることを確認します。   

12. **[多要素認証が必要]** を選択します。

13. **[選択]** をクリックします。

14. **[セッション]** で、**[0 個のコントロールが選択されました]** をクリックします。 **[サインイン頻度]** を選択し、次に **[毎回]** を選択します。

15. **[選択]** をクリックします。

16. 設定を確認し、 **[Enable policy](ポリシーの有効化)** を **[オン]** に設定します。

17. **[作成]** をクリックして、ポリシーを有効化します。

#### タスク 4:Azure AD Identity Protection ポリシーに対するリスク イベントのシミュレーション 

> このタスクを開始する前に、演習 1 で開始したテンプレートのデプロイが完了していることを確認してください。 デプロイには、**az500-04-vm1** という名前の Azure VM が含まれます。 

1. Azure portal で、**[ディレクトリ + サブスクリプション]** フィルターを、**az500-04-vm1** Azure VM をデプロイした Azure サブスクリプションに関連付けられている Azure AD テナントに設定します。

2. Azure portal の **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで、Azure portal ページの上部に「**Virtual Machines**」と入力し、**Enter** キーを押します。

3. **[仮想マシン]** ブレードで、**az500-04-vm1** エントリをクリックします。 

4. **[az500-04-vm1]** ブレードで、**[接続]** をクリックします。 **[RDP]** タブが表示されていることを確認します。

5. **[RDP ファイルのダウンロード]** をクリックし、これを使用して、リモート デスクトップ経由で **az500-04-vm1** Azure VM に接続します。 認証を求めるプロンプトが表示されたら、次の認証情報を入力します。

    |設定|値|
    |---|---|
    |ユーザー名|**Student**|
    |パスワード|**ラボ 04 > 演習 1 > タスク 1 > 手順 9 で作成した個人用パスワードを使用してください。**|

    >**注**:リモート デスクトップ セッションと **サーバー マネージャー** が読み込まれるまで待ちます。  

    >**注**:次の手順は、**az500-04-vm1** Azure VM へのリモート デスクトップ セッションで実行されます。 

6. **サーバー マネージャー** で **[ローカル サーバー]** をクリックし、**[IE セキュリティ強化の構成]** をクリックします。

7. **[Internet Explorer セキュリティ強化の構成]** ダイアログ ボックスで、両方のオプションを **[オフ]** に設定し、**[OK]** をクリックします。

8. **Internet Explorer** を起動し、ツールバーの歯車アイコンをクリックし、ドロップダウン メニューの **[安全性]** をクリックし、**[InPrivate ブラウズ]** をクリックします。

9. [InPrivate Inernet Explorer] ウィンドウで、**https://www.torproject.org/projects/torbrowser.html.en** の ToR ブラウザー プロジェクトに移動します。

10. Windows バージョンの ToR ブラウザーをダウンロードして、既定の設定でインストールします。 

11. インストールが完了したら、ToR ブラウザーを起動し、最初のページの **[接続]** オプションを使用して、**https://myapps.microsoft.com** のアプリケーション アクセス パネルに移動します。

12. プロンプトが表示されたら、**aaduser3** アカウントでサインインを試みます。 

    >**注**:**サインインがブロックされました**というメッセージが表示されます。 これは想定されていることです。このアカウントが、ToR ブラウザーの使用に伴うサインイン リスク増大によって必要とされる、多要素認証で構成されていないことが理由です。

13. ToR ブラウザーで戻る矢印を選択して、このラボで前に作成し、多要素認証用に構成した **aaduser1** アカウントとしてサインインします。

    >**注**:今回は、**不審なアクティビティが検出されました**というメッセージが表示されます。 これも想定されていることです。このアカウントは多要素認証で構成されているためです。 ToR ブラウザーの使用に伴うサインイン リスクの増加を考慮すると、多要素認証を使用する必要があります。

14. **[確認]** オプションを使用して、テキスト メッセージまたは電話を使用して本人確認を行うかどうかを指定します。

15. 検証を完了し、アプリケーション アクセス パネルに正常にサインインしたことを確認します。

16. RDP セッションを閉じます。 

    >**注**:この時点で、2 つの異なるサインインを試みました。次に、Azure ID 保護レポートを確認します。

#### タスク 5:Azure AD Identity Protection レポートを確認する

このタスクでは、ToR ブラウザーのログインから生成された Azure AD Identity Protection レポートを確認します。

1. Azure portal に戻り、**Directory + Subscription** フィルターを使用して **AdatumLab500-04** Azure Active Directory テナントに切り替えます。

2. **[AdatumLab500-04]** ブレードの **[管理]** セクションで、**[セキュリティ]** をクリックします。

3. **[セキュリティ \| はじめに]** ブレードの **[レポート]** セクションで、**[危険なユーザー]** をクリックします。 

4. レポートを確認し、**aaduser3** ユーザーアカウントを参照しているエントリを特定します。

5. **[セキュリティ \| はじめに]** ブレードの **[レポート]** セクションで、**[危険なサインイン]** をクリックします。 

6. レポートを確認し、**aaduser3** ユーザー アカウントでサインインに対応するエントリを特定します。

7. **[レポート]** で **[リスク検出]** をクリックします。

8. レポートを確認し、ToR ブラウザーによって生成された匿名 IP アドレスからのサインインを表すエントリを特定します。 

    >**注**:リスクがレポートに表示されるまでに 10 分から 15 分かかる場合があります。

> **Result**:Azure AD Identity Protection、構成されたユーザー リスク ポリシーとサインイン リスク ポリシー、およびリスク イベントをシミュレートして検証済みの Azure AD Identity Protection 構成を有効にしました。

**リソースをクリーンアップする**

> 使用しなくなった ID 保護リソースを削除する必要があります。 

**AdatumLab500-04** Azure AD テナントの ID 保護ポリシーを無効にするには、次の手順を使用します。

1. Azure portal で、**[AdatumLab500-04]** Azure Active Directory テナント ブレードに移動します。

2. **[AdatumLab500-04]** ブレードの **[管理]** セクションで、**[セキュリティ]** をクリックします。

3. **[セキュリティ \| はじめに]** ブレードの **[保護]** セクションで、**[Identity Protection]** をクリックします。

4. **[Identity Protection \| 概要]** ブレードで、**[ユーザー リスク ポリシー]** をクリックします。

5. **[Identity Protection \| ユーザー リスク ポリシー]** ブレードで **[ポリシーの適用]** を **[無効]** に設定し、 **[保存]** をクリックします。

6. **[Identity Protection \| ユーザー リスク ポリシー]** ブレードで、**[サインイン リスク ポリシー]** をクリックします。

7. **[Identity Protection \| サインイン リスク ポリシー]** ブレードで **[ポリシーの適用]** を **[無効]** に設定し、 **[保存]** をクリックします。

ラボで前にプロビジョニングした Azure VM を停止するには、次の手順を実行します。

1. Azure portal で、**[ディレクトリ + サブスクリプション]** フィルターを、**az500-04-vm1** Azure VM をデプロイした Azure サブスクリプションに関連付けられている Azure AD テナントに設定します。

2. Azure portal の **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで、Azure portal ページの上部に「**Virtual Machines**」と入力し、**Enter** キーを押します。

3. **[仮想マシン]** ブレードで、**az500-04-vm1** エントリをクリックします。 
 
4. **[az500-04-vm1]** ブレードで **[停止]** をクリックし、確認を求めるプロンプトが表示されたら **[OK]** をクリックします 

>  PIM ラボはリソースに依存しているため、このラボでプロビジョニングされたリソースは削除しないでください。
