---
lab:
    title: '04 - MFA、条件付きアクセス、および AAD Identity Protection'
    module: 'モジュール 01 - ID とアクセスを管理する'
---

# 課題 04: MFA、条件付きアクセス、および AAD Identity Protection
# 受講生用ラボ マニュアル

## ラボ シナリオ

Azure Active Directory (Azure AD) 認証を強化する機能の概念実証を作成するように求められました。具体的には、以下を評価する必要があります。

- Azure AD Multi-Factor Authentication
- Azure AD 条件付きアクセス
- Azure AD Identity Protection

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: Azure Resource Manager テンプレートを使用して Azure VM をデプロイする
- 演習 2: Azure MFA を実装する
- 演習 3: Azure AD 条件付きアクセス ポリシーを実装する 
- 演習 4: Azure AD Identity Protection を実装する

## ラボ ファイル:

- **\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.json**
- **\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.parameters.json** 

### 演習 1: Azure Resource Manager テンプレートを使用して Azure VM をデプロイする

### 予想時間: 10 分

この演習では、次のタスクを行います。

- タスク 1: Azure Resource Manager テンプレートを使用して Azure VM をデプロイします。

#### タスク 1: Azure Resource Manager テンプレートを使用して Azure VM をデプロイする

このタスクでは、ARM テンプレートを使用して仮想マシンを作成します。この仮想マシンは、このラボの最後の演習で使用されます。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**: このラボで使用している Azure サブスクリプションの所有者または共同作成者のロールと、そのサブスクリプションに関連付けられている Azure AD テナントのグローバル管理者の役割を持つアカウントを使用して、Azure portal にサインインします。

2. Azure portal で Azure portal ページの上部にある「**リソース、サービス、ドキュメントの検索**」テキスト ボックスで、「**カスタム テンプレートをデプロイする**」と入力します。

    >**注**: 「**マーケットプレイス**」 リストから **テンプレートのデプロイ（カスタムテンプレートを使用してデプロイ）** を選択することも可能です。

3. **カスタム デプロイ** ブレードで、**エディターで独自のテンプレートを作成する** のオプションをクリックします。

4. 「**テンプレートの編集**」 ブレードで、「**ファイルの読み込み**」 をクリックし、**\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.json** ファイルを見つけて、「**開く**」 をクリックします。

    > **注**: テンプレートの内容を確認し、Windows Server 2019 の Datacenter をホストする Azure VM をデプロイしていることを確認してください。

5. **「テンプレートの編集」** ブレードで、**「保存」** をクリックします。

6. 「**カスタム デプロイ**」 ブレードに戻って、「**パラメーターの編集**」 をクリックします。

7. 「**パラメーターの編集**」 ブレードで、「**ファイルの読み込み**」 をクリックし、**\\Allfiles\\Labs\\04\\az-500-04_azuredeploy.parameters.json** ファイルを見つけて、「**開く**」 をクリックします。

    >**注**: パラメーター ファイルの内容を確認し、adminUsername 値と adminPassword 値を示します。

8. **「パラメーターの編集」** ブレードで、**「保存」** をクリックします。

9. **「カスタム デプロイ」** ブレードで、次の設定が構成されていることを確認します (既定値を使用して他の設定を行います)。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ|「**新規作成**」 をクリックして、「**AZ500Lab04**」という名前を入力します|
   |リージョン|**米国東部**|
   |VM サイズ|**Standard_D2s_v3**|
   |VM 名|**az500-04-vm1**|
   |管理者ユーザー名|**Student**|
   |管理者のパスワード|**Pa55w.rd1234**|
   |仮想ネットワーク名|**az500-04-vnet1**|

    >**注**: Azure VM をプロビジョニングできる Azureリージョンを特定するには、次を参照してください。[**https://azure.microsoft.com/ja-jp/regions/offers/**](https://azure.microsoft.com/ja-jp/regions/offers/)

10. **「確認と作成」** をクリックし、**「作成」** をクリックします。

    >**注**: デプロイメントが完了するのを待たず、次のエクササイズに進みます。このラボの最後の演習では、このデプロイに含まれる仮想マシンを使用します。

> 結果: このラボの最後の演習で使用する Azure VM **az500-04-vm1** のテンプレートのデプロイを開始しました。


### 演習 2: Azure MFA を実装する

### 予想時間: 30 分

この演習では、次のタスクを行います

- タスク 1: 新しい Azure AD テナントを作成します。
- タスク 2: Azure AD Premium P2 試用版を有効化します。
- タスク 3: Azure AD ユーザーとグループを作成します。
- タスク 4: Azure AD ユーザーに Azure AD Premium P2 ライセンスを割り当てます。
- タスク 5: Azure MFA 設定を構成します。
- タスク 6: MFA 構成の検証

#### タスク 1: 新しい Azure AD テナントを作成

このタスクでは、新しい Azure AD テナントを作成します。 

1. Azure portal の 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に「**Azure Active Directory**」と入力し、**Enter** キーを押します。

2. 現在の Azure AD テナントの**概要**を表示しているブレードで、「**テナントの管理**」をクリックし、次の画面で「**+ 作成**」をクリックします。

3. 「**テナントの作成**」 ブレードの 「**基本**」 タブで、オプション 「**Azure Active Directory**」 が選択されていることを確認し、「**次へ**」 をクリックします。

4. 「**テナントの作成**」 ブレードの 「**構成**」 タブで、次の設定を指定します。

   |設定|値|
   |---|---|
   |組織名|**AdatumLab500-04**|
   |初期ドメイン名|文字と数字の組み合わせから成る一意の名前|
   |国/地域|**米国**|

    > **注**: 初期ドメイン名を記録します。これは、このラボで後ほど必要になります。

5. 「**確認および作成**」 をクリックし、「**作成**」 をクリックします。
6. 「**ロボットではないことを証明するのを手伝ってください**」ブレードにキャプチャ コードを追加し、「**送信**」ボタンをクリックします。 

    >**注**: 新しいテナントが作成されるのを待ちます。**通知** アイコンを使用して、デプロイ ステータスを監視します。 


#### タスク 2: Azure AD Premium P2 試用版のアクティブ化

このタスクでは、Azure AD Premium P2 無料試用版にサインアップします。 

1. Azure portal のツール バーで、Cloud Shell アイコンの右側にある 「**ディレクトリ + サブスクリプション**」 アイコンをクリックします。 

2. 「**Directory + subscription**」ブレードで、新しく作成したテナント「**AdatumLab500-04**」をクリックし、「**切り替え**」ボタンをクリックして、現在のディレクトリとして設定します。

    >**注**: **AdatumLab500-04** エントリが **ディレクトリ + サブスクリプション** のフィルター リストに表示されない場合は、ブラウザーの画面を更新する必要があります。

3. Azure portal の 「**リソース、サービス、ドキュメントの検索**」テキスト ボックスで、Azure portal ページの上部に「**Azure Active Directory**」と入力し、**Enter** キーを押します。「**AdatumLab500-04**」ブレードの「**管理**」セクションで、「**ライセンス**」をクリックします。

4. 「**ライセンス \| 概要**」 ブレードの 「**管理**」 セクションで、「**すべての製品**」 をクリックし、「**+ 試用/購入**」 をクリックします。

5. 「**アクティブ化**」 ブレードの 「Azure AD Premium P2」 セクションで、「**無料試用版**」 をクリックし、「**アクティブ化**」 をクリックします。


#### タスク 3: Azure AD ユーザーとグループを作成します。

このタスクでは、aaduser1 (グローバル管理者)、aaduser2 (ユーザー)、および aaduser3 (ユーザー) の 3 つのユーザーを作成します。後のタスクには、各ユーザーのプリンシパル名とパスワードが必要です。 

1. 「**AdatumLab500-04** Azure Active Directory」 ブレードに戻り、「**管理**」 セクションで、「**ユーザー**」 をクリックします。

2. 「**ユーザー \| すべてのユーザー**」ブレードに戻り、「**+ 新しいユーザー**」をクリックします。 

3. 「**新しいユーザー**」 ブレードで、「**ユーザーの作成**」 オプションが選択されていることを確認し、次の設定を指定し (その他の設定はすべて既定値のままにします)、「**作成**」 をクリックします。

   |設定|値|
   |---|---|
   |ユーザー名|**aaduser1**|
   |名前|**aaduser1**|
   |パスワード|「**パスワードの自動生成**」 オプションが選択されていることを確認し、「**パスワードの表示**」 をクリックします。|
   |グループ|**0 グループが選択されました**|
   |役割|「**ユーザー**」 をクリックし、「**グローバル管理者**」 をクリックし、「**選択**」 をクリックします。|
   |利用場所|**United States**|  

    > **注**: 完全なユーザー名を記録します。ドロップダウン リストの右側にある 「**クリップボードにコピー**」 ボタンをクリックして、ドメイン名を表示することで、値をコピーできます。 

    > **注**: ユーザーのパスワードを記録します。これは、このラボの後半で必要になります。 

4. 「**ユーザー \| すべてのユーザー**」ブレードに戻り、「**+ 新しいユーザー**」をクリックします。 

5. 「**新しいユーザー**」 ブレードで、「**ユーザーの作成**」 オプションが選択されていることを確認し、次の設定を指定します (その他の設定はすべて既定値のままにします)。

   |設定|値|
   |---|---|
   |ユーザー名|**aaduser2**|
   |名前|**aaduser2**|
   |パスワード|「**パスワードの自動生成**」 オプションが選択されていることを確認し、「**パスワードの表示**」 をクリックします。|
   |グループ|**0 グループが選択されました**|
   |役割|**ユーザー**|
   |利用場所|**United States**|  

    > **注**: 完全なユーザー名とパスワードを記録します。

6. 「**ユーザー \| すべてのユーザー**」ブレードに戻り、「**+ 新しいユーザー**」をクリックします。 

7. 「**新しいユーザー**」 をクリックし、新しいユーザー構成設定を完了して、「**作成**」 をクリックします。

   |設定|値|
   |---|---|
   |ユーザー名|**aaduser3**|
   |名前|**aaduser3**|
   |パスワード|「**パスワードの自動生成**」 オプションが選択されていることを確認し、「**パスワードの表示**」 をクリックします。|
   |グループ|**0 グループが選択されました**|
   |ロール|**ユーザー**|
   |利用場所|**United States**|  

    >**注**: 完全なユーザー名とパスワードを記録します。

    >**注**: この時点で、「**ユーザー**」 ページに 3 人の新しいユーザーが表示されます。 
	
#### タスク 4: Azure AD ユーザーに Azure AD Premium P2 ライセンスを割り当てる

このタスクでは、各ユーザーを Azure Active Directory Premium P2 ライセンスに割り当てます。

1. 「**ユーザー \| すべてのユーザー (プレビュー)**」ブレードで、ユーザー アカウントを表すエントリをクリックします。 

2. ユーザー アカウントのプロパティを表示するブレードで、「**編集**」をクリックします。  使用場所が設定されていない場合は、使用場所が**米国**に設定されていることを確認し、「**保存**」をクリックします。

3. 「**AdatumLab500-04** Azure Active Directory」ブレードに戻り、「**管理**」セクションで、「**ライセンス**」をクリックします。

4. 「**ライセンス \| 概要**」ブレードで、「**すべての製品**」をクリックし、「**Azure Active Directory Premium P2**」チェックボックスを選択し、「**+ 割り当て**」をクリックします。

5. 「**ライセンスの割り当て**」ブレードで、「**+ ユーザーとグループの追加**」をクリックします。

6. 「**ユーザー**」ブレードで、**aaduser1**、**aaduser2**、 **aaduser3**、およびユーザー アカウントを選択し、「**選択**」をクリックします。

7. 「**ライセンスの割り当て**」ブレードに戻り、「**割り当てオプション**」をクリックし、すべてのオプションが有効になっていることを確認して、「**レビュー + 割り当て**、次に「**割り当て**」をクリックします。

8. Azure portal からサインアウトし、同じアカウントを使用して再びサインインします。ライセンスの割り当てを有効にするためには、この手順が必要です。

    >**注**: この時点で、このラボで使用するすべてのユーザー アカウントに Azure Active Directory Premium P2 ライセンスを割り当ててください。必ずサインアウトしてから、再度サインインしてください。 

#### タスク 5: Azure MFA 設定を構成します。

このタスクでは、MFA を構成し、aaduser1 の MFA を有効にします。 

1. Azure portal で、「**AdatumLab500-04**」 Azure Active Directory テナント ブレードに移動します。

    >**注**: AdatumLab500-04 Azure AD テナントを使用していることを確認します。

2. 「**AdatumLab500-04** Azure Active Directory テナント」 ブレードの 「**管理**」 セクションで、「**セキュリティ**」 をクリックします。

3. 「**セキュリティ \| はじめに**」 ブレードの 「**管理**」 セクションで、「**MFA**」 をクリックします。

4. 「**Multi-Factor Authentication \| はじめに**」 ブレードで、「**追加のクラウド ベース MFA 設定**」 リンクをクリックします。 

    >**注**: 新しいブラウザー タブに、**多要素認証**ページが表示されます。

5. **多要素認証**ページで、「**サービス設定**」 タブをクリックします。**検証オプション**を確認します。「**電話へのテキスト メッセージ**」、「**モバイル アプリによる通知**」、「**モバイル アプリまたはハードウェア トークンからの確認コード**」 が有効になっていることに注意してください。「**保存**」 をクリックしてから、「**閉じる**」 をクリックします。

6. 「**ユーザー**」 タブに切り替えて、「**aaduser1**」 エントリをクリックし、「**有効にする**」 リンクをクリックします。プロンプトが表示されたら、「**Multi-Factor Auth を有効にする**」 をクリックします。

7. **aaduser1** の 「**Multi-Factor Authentication の状態**」 列が 「**有効**」 になったことに注目してください。

8. **aaduser1** をクリックすると、この時点で 「**強制**」 オプションも表示されます。 

    >**注**: ユーザーの状態を 「有効」 から 「強制」 に変更すると、Azure MFA をサポートしない従来の Azure AD 統合アプリのみが影響を受け、状態が 「強制」 に変更されるとアプリ パスワードの使用が要求されます。

9. **aaduser1** エントリを選択した状態で、「**ユーザー設定の管理**」 をクリックし、使用可能なオプションを確認します。 

   - 選択したユーザーについて連絡方法の再指定を必須にする

   - 選択したユーザーが生成したすべての既存のアプリケーション パスワードを削除する

   - 記憶されているすべてのデバイスに多要素認証を復元

10. 「**キャンセル**」 をクリックし、「**Multi-Factor Authentication \| はじめに**」 ブレードを表示するブラウザー タブに戻ります。

11. 「**設定**」 セクションで、「**不正アクセスのアラート**」 をクリックします。

12. 「**Multi-Factor Authentication \| 不正アクセスのアラート**」 ブレードで、次の設定を構成します。

   |設定|値|
   |---|---|
   |ユーザーが不正アクセスを通報できるようにする|**オン**|
   |不正を通報するユーザーを自動的にブロックする|**オン**|
   |案内メッセージ後に入力する不正アクセス通報コード|**0**|

13. 「**保存**」 をクリックする

    >**注**: この時点で、aaduser1 の MFA を有効にし、不正アクセスのアラートの設定を構成しました。 

14. **AdatumLab500-04** Azure ActiveDirectory テナントブレードに戻り、「**管理**」 セクションで 「**プロパティ**」 をクリックし、次にブレードの下にある 「**セキュリティの既定値群の管理**」 リンクをクリックし、「**セキュリティの既定値群の有効化**」 ブレードで、ブレードで 「**いいえ**」 をクリックします。理由には、 「**自分の組織では条件付きアクセスを使用している**」 を選択し、「**保存**」 をクリックします。

    >**注**: **AdatumLab500-04** Azure AD テナントにサインインしていることを確認します。**ディレクトリ + サブスクリプション** フィルターを使用して、Azure AD テナント間で切り替えることができます。Azure AD テナントでグローバル管理者の役割を持つユーザーとしてサインインしていることを確認します。

#### タスク 6: MFA 構成の検証

このタスクでは、aaduser1 ユーザー アカウントのサインインをテストして MFA 構成を検証します。 

1. InPrivate ブラウザーの画面を開きます。

2. Azure portal に移動し、**aaduser1** ユーザー アカウントを使用してサインインします。 

    >**注**: サインインするには、このラボで前に記録した Azure AD テナントの DNS ドメイン名を含む、**aaduser1** ユーザー アカウントの完全修飾名を指定する必要があります。このユーザー名は、aaduser1@`<your_tenant_name>`.onmicrosoft.com の形式で、 `<your_tenant_name>` は一意の Azure AD テナント名を表すプレースホルダーです。 

3. メッセージが表示されたら、「詳細情報が必要」 ダイアログ ボックスで 「次へ」 をクリックします。

    >**注**: ブラウザー セッションは、「追加のセキュリティ検証」 ページにリダイレクトされます。

4. 「**アカウントのセキュリティ保護**」 ページで、「**別の方法を設定します**」 リンクを選択し、「**どの方法を使用しますか？**」 ドロップダウンリストで 「**電話**」 を選択し、「**確認**」 を選択します。

5. 「**アカウントのセキュリティ保護**」 ページで、国または地域を選択し、「**電話番号を入力する**」 領域に携帯電話番号を入力し、「**コードをSMS送信する**」 オプションが選択されていることを確認して、「**次へ**」 をクリックします。
 
6. 「**アカウントのセキュリティ保護**」 ページで、携帯電話にテキストメッセージで受信したコードを入力し、「**次へ**」 をクリックします。

7. 「**アカウントのセキュリティ保護**」 ページで、確認が成功したことを確認し、「**次へ**」 をクリックします。

8. 「**アカウントのセキュリティ保護**」ページで、「**I want to use a different method**」 (別の方法を設定します) をクリックし、ドロップ ダウン リストから「**電子メール**」を選択します。「**確定**」をクリックし、使用するメール アドレスを入力して「**次へ**」をクリックします。メールが届いたら、メール本文に記載されているコードを確認して入力し、「**完了**」をクリックします。

9. プロンプトが表示されたら、パスワードを変更します。新しいパスワードを必ず記録してください。

10. Azure portal に正常にサインインしたことを確認します。

11. **aaduser1** としてサインアウトし、InPrivate ブラウザーの画面を閉じます。

> 結果: 新しい AD テナントを作成し、AD ユーザーを構成し、MFA を構成し、ユーザーの MFA エクスペリエンスをテストしました。 


### 演習 3: Azure AD 条件付きアクセス ポリシーを実装する 

### 予想時間: 15 分

この演習では、次のタスクを行います 

- タスク 1: 条件付きアクセス ポリシーを構成します。
- タスク 2: 条件付きアクセス ポリシーをテストします。

#### タスク 1: 条件付きアクセス ポリシーを構成します。 

このタスクでは、条件付きアクセス ポリシー設定を確認し、Azure portal にサインインするときに MFA を必要とするポリシーを作成します。 

1. Azure portal で、**AdatumLab500-04** Azure Active Directory テナント ブレードに戻ります。

2. 「**AdatumLab500-04**」 ブレードの 「**管理**」 セクションで、「**セキュリティ**」 をクリックします。

3. 「**セキュリティ \| はじめに**」 ブレードの 「**保護**」 セクションで、「**条件付きアクセス**」 をクリックします。

4. **「条件付きアクセス \| 「ポリシー」** ブレードで、「**+ 新しいポリシー**」をクリックし、ドロップダウン リストから「**新しいポリシーの作成**」を選択します。 

5. **新規**のブレードで、次の設定を構成します。

   - 「**名前**」 テキスト ボックスに「**AZ500Policy1**」と入力する
	
   - 「**選択したユーザーまたはワークロード ID**」をクリックします。右側の「このポリシーの適用対象」 >> 「ユーザーとグループ」 >> 「含める」 >> 「**ユーザーとグループの選択**を有効にする」 >> 「**ユーザーとグループ**」チェックボックスを選択し、「**選択**」ブレードで「**aaduser2**」をクリックして、「**選択**」をクリックします。
	
   - 「**クラウド アプリまたはアクション**」をクリックし、「**アプリを選択**」をクリックし、「**選択**」ブレードで 「**Microsoft Azure 管理**」 をクリックして、 「**選択**」をクリックします。 

    > **注**: このポリシーが Azure portal へのアクセスに影響を与えるという警告を確認します。
	
   - 「**条件**」 をクリックし、「**サインインリスク**」 をクリックし、 **サインインのリスク** ブレードで、リスク レベルを確認しますが、変更は行わないで 「**サインインのリスク**」 ブレードを閉じます。
	
   - 「**デバイス プラットフォーム**」をクリックし、含めることができるデバイス プラットフォームを確認して、「**完了**」をクリックします。
	
   - 「**場所**」 をクリックし、変更を加えずに場所のオプションを確認します。
	
   - 「**アクセス制御**」 セクションの 「**許可**」 をクリックし、**許可** ブレードで、「**多要素認証を要求する**」 チェックボックスをオンにして、 「**選択**」 をクリックします
	
   - 「**ポリシーの有効化**」 を 「**オン**」 に設定します

6. **新規** ブレードで、「**作成**」 をクリックします。 

    >**注**: この時点で、条件付きアクセス ポリシーを使用して、MFA が Azure portal にサインインする必要があります。 

#### タスク 2: 条件付きアクセス ポリシーをテストします。

このタスクでは、Azure portal に **aaduser2** としてサインインし、MFA が必要であることを確認します。また、次の演習に進む前に、ポリシーを削除します。 

1. InPrivate Microsoft Edge ウィンドウを開きます。

2. 新しいブラウザーの画面で、Azure portal に移動し**aaduser2** ユーザー アカウントでサインインします。

3. プロンプトが表示されたら、「**詳細情報が必要**」 ダイアログ ボックスで 「**次へ**」 をクリックします。

    >**注**: ブラウザー セッションは、**アカウントのセキュリティ保護**のページにリダイレクトされます。
    
4. 「**アカウントのセキュリティ保護**」 ページで、「**別の方法を設定します**」 リンクを選択し、「**どの方法を使用しますか？**」 ドロップダウンリストで 「**電話**」 を選択し、「**確認**」 を選択します。

5. 「**アカウントのセキュリティ保護**」 ページで、国または地域を選択し、「**電話番号を入力する**」 領域に携帯電話番号を入力し、「**コードをSMS送信する**」 オプションが選択されていることを確認して、「**次へ**」 をクリックします。

6. 「**アカウントのセキュリティ保護**」 ページで、携帯電話にSMSで受信したコードを入力し、「**次へ**」 をクリックします。

7. 「**アカウントのセキュリティ保護**」 ページで、確認が成功したことを確認し、「**次へ**」 をクリックします。

8. 「**アカウントのセキュリティ保護**」 ページで、「**完了**」 をクリックします。

9. プロンプトが表示されたら、パスワードを変更します。新しいパスワードを必ず記録してください。

10. Azure portal に正常にサインインしたことを確認します。

11. **aaduser2** としてサインアウトし、InPrivate ブラウザーの画面を閉じます。

    >**注**: aaduser2 が Azure portal にサインインするときに、新しく作成された条件付きアクセスポリシーが MFA を適用することを確認しました。

12. Azure portal を表示しているブラウザーの画面に戻り、「**AdatumLab500-04** Azure Active Directoryテナント」 ブレードに戻ります。

13. 「**AdatumLab500-04**」 ブレードの 「**管理**」 セクションで、「**セキュリティ**」 をクリックします。

14. 「**セキュリティ \| はじめに**」 ブレードの 「**保護**」 セクションで、「**条件付きアクセス**」 をクリックします。

15. 「**条件付きアクセス \| ポリシー**」 ブレードで **「AZ500Policy1」** の横の省略記号をクリックして 「**削除**」 をクリックし、確認を求められたら 「**はい**」 をクリックします。

    >**注**: 結果: この演習では、条件付きアクセスポリシーを導入して、ユーザーが Azure portal にサインインするときに MFA を要求します。 

>結果: Azure AD の条件付きアクセスを構成してテストしました。

### 演習 4: Azure AD Identity Protection を実装する

### 予想時間: 30 分

この演習では、次のタスクを行います 

- タスク 1: Azure portal で Azure AD ID 保護オプションを表示する
- タスク 2: ユーザー リスク ポリシーの構成
- タスク 3: サインイン リスク ポリシーを構成する
- タスク 4: Azure AD Identity Protection ポリシーに対するリスク イベントのシミュレーション 
- タスク 5: Azure AD Identity Protection レポートを確認する

#### タスク 1: Azure AD Identity Protection を有効化する

このタスクでは、Azure portal で Azure AD Identity Protection オプションを表示します。 

1. 必要に応じて、Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**: **AdatumLab500-04** Azure AD テナントにサインインしていることを確認します。**ディレクトリ + サブスクリプション** フィルターを使用して、Azure AD テナント間で切り替えることができます。Azure AD テナントでグローバル管理者の役割を持つユーザーとしてサインインしていることを確認します。

2. 「**AdatumLab500-04**」 ブレードの 「**管理**」 セクションで、「**セキュリティ**」 をクリックします。

3. 「**セキュリティ \| はじめに**」 ブレードの 「**保護**」 セクションで、「**Identity Protection**」 をクリックします。

4. 「**Identity Protection \| 概要**」 ブレードで、「**保護**」、「**レポート**」、「**通知**」 の各オプションを確認します。 

#### タスク 2: ユーザー リスク ポリシーの構成

このタスクでは、ユーザー リスク ポリシーを作成します。 

1. 「**Identity Protection \| 概要**」 ブレードで、「**保護**」 セクションの 「**ユーザー リスク ポリシー**」 をクリックします。

2. 次の設定を使用して、**ユーザー リスクの修復ポリシー**を構成します。 

   - 「**ユーザー**」をクリックし、「**ユーザー**」ブレードの「**含める**」タブで、「**すべてのユーザー**」オプションを選択します。

   - 「**ユーザー**」ブレードで「**除外**」タブに切り替え、「**除外されたユーザーを選択**」をクリックします。ユーザー アカウントを選択して「選択」をクリックし、「**完了**」をクリックします。 

   - 「**ユーザーリスク**」をクリックし、「**ユーザーリスク**」ブレードで、「**低以上**」を選択し、「**完了**」をクリックします。 

   - 「**アクセス**」をクリックし 、「**アクセス**」ブレードで 「**アクセスを許可**」オプションと「**パスワードの変更を要求**」チェック ボックスがオンになっていることを確認し、「**完了**」をクリックします。

   - 「**ポリシーの適用**」を「**オン**」に設定し、「**保存**」をクリック します。

#### タスク 3: サインイン リスク ポリシーの構成

このタスクでは、サインイン リスク ポリシーを構成します。 

1. 「**Identity Protection \| ユーザー リスク ポリシー**」 ブレードの 「**保護**」 セクションで、「**サインイン リスク ポリシー**」 をクリックします

2. **サインイン リスク是正ポリシー**を次の設定で構成します。 

   - 「**ユーザー**」をクリックし、「**ユーザー**」ブレードの「**含める**」タブで、「**すべてのユーザー**」オプションを選択します。

   - 「**サインイン リスク**」 をクリックし、「**サインイン リスク**」 ブレードで、「**中以上**」を選択し、「**完了**」をクリックします。 

   - 「**アクセス**」をクリックし、「**アクセス**」ブレードで 「**アクセスを許可する**」オプションと「**多要素認証を要求する**」チェックボックスがオンになっていることを確認し、「**完了**」をクリックします。

   - 「**ポリシーの適用**」を「**オン**」に設定し、「**保存**」をクリック します。

#### タスク 4: Azure AD Identity Protection ポリシーに対するリスク イベントのシミュレーション 

> このタスクを開始する前に、演習 1 で開始したテンプレートのデプロイが完了していることを確認してください。デプロイには、**az500-04-vm1** という名前の Azure VM が含まれます。 

1. Azure portal で、**ディレクトリ + サブスクリプション** フィルターを、**az500-04-vm1** Azure VM をデプロイした Azure サブスクリプションに関連付けられている Azure AD テナントに設定します。

2. Azure portal の 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に「**Virtual Machines**」と入力し、**Enter** キーを押します。

3. 「**仮想マシン**」 ブレードで、**az500-04-vm1** エントリをクリックします。 

4. 「**az500-04-vm1**」 ブレードで 「**接続**」 をクリックし、ドロップ ダウン メニューの 「**RDP**」 をクリックします。 

5. 「**RDP ファイルのダウンロード**」 をクリックし、これを使用して、リモート デスクトップ経由で**az500-04-vm1** Azure VM に接続します。認証を求められたら、次の資格情報を入力します。

   |設定|値|
   |---|---|
   |ユーザー名|**Student**|
   |パスワード|**Pa55w.rd1234**|

    >**注**: リモート デスクトップ セッションと **サーバー マネージャー** が読み込まれるまで待ちます。  

    >**注**: 次の手順は、**az500-04-vm1** Azure VM へのリモート デスクトップ セッションで実行されます。 

6. **Server Manager** で 「**Local Server**」 をクリックし、「**IE Enhanced Security Configuration**」 をクリックします。

7. 「**Internet Explorer Enhanced Security Configuration**」 ダイアログ ボックスで、両方のオプションを 「**Off**」 に設定し、「**OK**」 をクリックします。

8. **Internet Explorer** を起動し、ツールバーの歯車アイコンをクリックし、ドロップダウン メニューの 「**Safety**」 をクリックし、「**InPrivate Browsing**」 をクリックします。

9. 「InPrivate Inernet Explorer」 ウィンドウで、[**https://www.torproject.org/projects/torbrowser.html.en**](https://www.torproject.org/projects/torbrowser.html.en) の ToR ブラウザー プロジェクトに移動します。

10. Windows バージョンの ToR ブラウザーをダウンロードして、既定の設定でインストールします。 

11. インストールが完了したら、ToR ブラウザーを起動し、最初のページの 「**Connect**」 オプションを使用して、[**https://myapps.microsoft.com**](https://myapps.microsoft.com) のアプリケーション アクセス パネルを参照します。

12. プロンプトが表示されたら、**aaduser3** アカウントでサインインを試みます。 

    >**注**: **Your sign-in was blocked** というメッセージが表示されます。このアカウントは多要素認証で構成されていないので、ToR ブラウザーの使用に伴うサインイン リスクの増大により、このアカウントが必要とされるため、この方法が予期されます。

13. 「**Sign out and sign in with a different account**」 オプションを使用して、このラボで前に作成し、多要素認証用に構成した **aaduser1** アカウントとしてサインインします。

    >**注**: 今回は、**Suspicious activity detected** というメッセージが表示されます。このアカウントは多要素認証で構成されているため、この方法も想定されます。ToR ブラウザーの使用に伴うサインイン リスクの増加を考慮すると、多要素認証を使用する必要があります。

14. 「**Verify**」 オプションを使用して、テキスト メッセージまたは電話を使用して本人確認を行うかどうかを指定します。

15. 検証を完了し、アプリケーション アクセス パネルに正常にサインインしたことを確認します。

16. RDP セッションを閉じます。 

    >**注**: この時点で、2 つの異なるサインインを試みました。次に、Azure ID 保護レポートを確認します。

#### タスク 5: Azure AD Identity Protection レポートを確認する

このタスクでは、ToR ブラウザーのログインから生成された Azure AD Identity Protection レポートを確認します。

1. Azure portal に戻り、**ディレクトリ + サブスクリプション** フィルターを使用して **AdatumLab500-04** Azure Active Directory テナントに切り替えます。

2. 「**AdatumLab500-04**」 ブレードの 「**管理**」 セクションで、「**セキュリティ**」 をクリックします。

3. 「**セキュリティ \| はじめに**」 ブレードの 「**レポート**」 セクションで、「**危険なユーザー**」 をクリックします。 

4. レポートを確認し、**aaduser3** ユーザーアカウントを参照しているエントリを特定します。

5. 「**セキュリティ \| はじめに**」 ブレードの 「**レポート**」 セクションで、「**危険なサインイン**」 をクリックします。 

6. レポートを確認し、**aaduser3** ユーザー アカウントでサインインに対応するエントリを特定します。

7. 「**レポート**」 で 「**リスク検出**」 をクリックします。

8. レポートを確認し、ToR ブラウザーによって生成された匿名 IP アドレスからのサインインを表すエントリを特定します。 

   >**注**: リスクがレポートに表示されるまでに10～15分かかる場合があります。

   >**結果**: Azure AD Identity Protection、構成されたユーザー リスク ポリシーとサインイン リスク ポリシー、およびリスク イベントをシミュレートして検証済みの Azure AD Identity Protection 構成を有効にしました。

**リソースをクリーン アップする**

> 使用しなくなった ID 保護リソースを削除する必要があります。 

**AdatumLab500-04** Azure AD テナントの ID 保護ポリシーを無効にするには、次の手順を使用します。

1. Azure portal で、「**AdatumLab500-04**」 Azure Active Directory テナント ブレードに移動します。

2. 「**AdatumLab500-04**」 ブレードの 「**管理**」 セクションで、「**セキュリティ**」 をクリックします。

3. 「**セキュリティ \| はじめに**」 ブレードの 「**保護**」 セクションで、「**Identity Protection**」 をクリックします。

4. 「**Identity Protection \| 概要**」 ブレードで、「**ユーザー リスク ポリシー**」 をクリックします。

5. 「**Identity Protection \| ユーザー リスク ポリシー**」 ブレードで 「**ポリシーを適用する**」 を 「**オフ**」 に設定し、「**保存**」 をクリックします。

6. 「**Identity Protection \| ユーザー リスク ポリシー**」 ブレードで、「**サインイン リスク ポリシー**」 をクリックします

7. 「**Identity Protection \| サインイン リスク ポリシー**」 ブレードで 「**ポリシーを適用する**」 を 「**オフ**」 に設定し、「**保存**」 をクリックします。

ラボで前にプロビジョニングした Azure VM を停止するには、次の手順を実行します。

1. Azure portal で、**ディレクトリ + サブスクリプション** フィルターを、**az500-04-vm1** Azure VM をデプロイした Azure サブスクリプションに関連付けられている Azure AD テナントに設定します。

2. Azure portal の 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、Azure portal ページの上部に「**Virtual Machines**」と入力し、**Enter** キーを押します。

3. 「**仮想マシン**」 ブレードで、**az500-04-vm1** エントリをクリックします。 
 
4. 「**az500-04-vm1**」 ブレードで 「**停止**」 をクリックし、確認を求めるプロンプトが表示されたら 「**OK**」 をクリックします 

>  PIM ラボはリソースに依存しているため、このラボでプロビジョニングされたリソースは削除しないでください。
