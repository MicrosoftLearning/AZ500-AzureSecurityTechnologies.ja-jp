---
lab:
  title: 02 - Azure Policy
  module: Module 01 - Manage Identity and Access
---

# <a name="lab-02-azure-policy"></a>ラボ 02:Azure Policy
# <a name="student-lab-manual"></a>受講生用ラボ マニュアル

## <a name="lab-scenario"></a>ラボのシナリオ

Azure Policy の使用方法を示す概念実証を作成するように依頼されました。 具体的には、次の操作が必要です。

- 特定のリージョンでのみリソースを作成を許可する場所ポリシーを作成します。
- リソースが許可された場所にのみ作成されることを確認するテスト

> このラボのすべてのリソースについて、**米国東部**リージョンを使用しています。 これがクラスで使用するリージョンであることを講師に確認します。 

## <a name="lab-objectives"></a>ラボの目的

このラボでは、次に挙げる演習を完了させます。

- 演習 1:Azure Policy を実装します。 

## <a name="azure-policy-diagram"></a>Azure Policy の図

![image](https://user-images.githubusercontent.com/91347931/157511920-19c1f06c-86bd-440d-80ac-d96aa27aefff.png)

## <a name="instructions"></a>Instructions

### <a name="exercise-1-implement-azure-policy"></a>演習 1:Azure Policy の実装

#### <a name="estimated-timing-20-minutes"></a>推定時間:20 分

この演習では、次のタスクを実行します。

- タスク 1:Azure リソース グループを作成する。 
- タスク 2:許可されている場所ポリシーの割り当てを作成する。
- タスク 3:許可されている場所ポリシーの割り当てが機能していることを確認します。 

#### <a name="task-1-create-a-resource-group-for-the-lab"></a>タスク 1:ラボ用のリソース グループを作成する。 

このタスクでは、このラボ用のリソース グループを作成します。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**:このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure portal にサインインします。

1. Azure portal の右上にある最初のアイコンをクリックして、Cloud Shell を開きます。 メッセージが表示されたら、**[PowerShell]** と **[ストレージの作成]** を選択します。

1. Cloud Shell ペインの左上隅にあるドロップダウン メニューで **[PowerShell]** が選択されていることを確認します。

1. [Cloud Shell] ウィンドウ内の PowerShell セッションで、次のコマンドを実行してリソース グループを作成します (場所のパラメーターの値について講師に確認します)。

    ```powershell
    New-AzResourceGroup -Name AZ500LAB02 -Location 'East US'
    ```

1. [Cloud Shell] ウィンドウ内の PowerShell セッションで、次の手順を実行してリソース グループを一覧表示し、新しいリソース グループが作成されたことを確認します。

    ```powershell
    Get-AzResourceGroup | format-table
    ```

1. **Cloud Shell**を閉じます。

#### <a name="task-2-create-an-allowed-locations-policy-assignment"></a>タスク 2:許可されている場所ポリシーの割り当てを作成する。

このタスクでは、許可されている場所ポリシーの割り当てを作成し、ポリシーを使用できる Azure リージョンを指定します。 

1. Azure portal で、ページ上部にある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスに「**ポリシー**」と入力し、**Enter** キーを押します。

1. **[ポリシー]** ブレードの **[作成]** セクションで、 **[定義]** を選択します。

1. 組み込みの定義を参照するには、しばらく時間がかかります。 **[カテゴリ]** ドロップダウンを使用して、ポリシーのリストをフィルターします。

1. **[検索]** テキスト ボックスに「**許可されている場所**」と入力します。 

   >**注**: **[許可されている場所]** ポリシーでは、リソース グループではなく、リソースの場所を制限できます。 リソース グループの場所を制限するには、 **リソース グループの許可されている場所** ポリシーを使用できます。

1.  **[許可されている場所]**   ポリシー定義をクリックして、その詳細を表示します。 

   >**注**:このポリシー定義は、パラメーターとして場所の配列を受け取ります。 ポリシー ルールは 'if-then' ステートメントです。 'if' 句は、リソースの場所がパラメーター リストに含まれているかどうかをチェックし、含まれていない場合は、'then' 句によりリソースの作成を拒否するか、既存のリソースの場合は非対応としてマークします。

1. **[許可されている場所]** ブレードで、 **[割り当て]** をクリックします。

1. **[許可されている場所]** ブレードの **[基本]** タブで 、 **[スコープ]** テキスト ボックスの横にある省略記号 (...) ボタンをクリックし、[**スコープ]** ブレードで次の設定を指定します。

   |設定|値|
   |---|---|
   |サブスクリプション|Azure サブスクリプションの名前|
   |Resource group|**AZ500LAB02**|

1. **[選択]** をクリックします。

1. **[許可されている場所]** ブレードの **[基本]** タブで、次の設定を指定します (その他の設定は既定値のままにします)。

   |設定|値|
   |---|---|
   |割り当て名|**AZ500LAB02 に英国南部を許可**|
   |説明|**AZ500LAB02 では英国南部のみでリソースを作成できるようにする**|
   |ポリシーの適用|**有効**|

1.  **[次へ]** をクリックします。

1. **[許可されている場所]** ブレードの **[パラメーター]** タブで、 **[許可されている場所]** ドロップダウン リストから、 **[英国南部]**   を唯一の許可されている場所として選択します。 

   >**注**:1 か所以上追加できます。 ポリシーで別のパラメーター セットが必要な場合は、このタブでその選択肢が表示されます。 

1.  **[Review + create]** をクリックしてから  **[作成]**   をクリックし、ポリシーの割り当てを作成します。 

   >**注**:割り当てが成功し、割り当てが完了するまでに約 30 分かかる場合があるという通知が表示されます。

   >**注**:Azure Policy の割り当てが有効化するのに最大 30 分かかる理由は、グローバルにレプリケートする必要があるためです。 通常では、この処理は数分で完了します。  次のタスクが失敗する場合は、数分待ってからもう一度手順を試みます。

#### <a name="task-3-test-the-allowed-locations-policy-assignment"></a>タスク 3:許可されている場所ポリシーの割り当てをテストする

このタスクでは、許可されている場所ポリシーのテストをします。 

1. Azure portal で、ページ上部にある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスに「**仮想ネットワーク**」と入力し、**Enter** キーを押します。

1. **[Virtual Networks]** ブレードで、 **[+ 作成]** をクリックします。

   >**注**:まず、米国東部で仮想ネットワークの作成を試みます。 これは許可された場所ではないため、要求はブロックされます。 

1. **[仮想ネットワークの作成]**   ブレードの **[基本]** タブで、次の設定を指定します (他の設定は既定値のままにします)。

    |設定|値|
    |---|---|
    |Resource group|**AZ500LAB02**|
    |名前|**myVnet**|
    |リージョン|**(米国) 米国東部**|

1.  **[確認と作成]** をクリックします。 

1. **[仮想ネットワークの作成]**   ブレードの **[確認と作成]** タブで、**検証に失敗しました** というメッセージを確認します。 

    > **注**: "**検証に失敗しました**" という警告が表示されない場合は、**[前へ]** をクリックして、さらに数分待ちます。

1. **[基本]** タブで、エラー メッセージ リンクをクリックして、 **[ポリシーの割り当て]** ブレードを開 きます。 その場所を制限するポリシーの割り当てが表示されます。

1. **[ポリシーの割り当て]** ブレードを閉じ、 **[仮想ネットワークの作成]** ブレードの **[基本]** タブをクリックし、 **[地域]** ドロップダウン リストから **[(ヨーロッパ) 英国南部]** を選択します。

1.  **[確認と作成]** をクリックして検証が成功したことを確認し、 **[作成]** をクリックして、仮想ネットワークが正常に作成されたことを確認します。 

> 演習結果:この演習では、組み込みのポリシー定義を選択し、それをリソース グループに割り当てることで、Azure ポリシーを適用する方法について学習しました。

**リソースをクリーンアップする**

> 新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しないコストが発生しなくなります。

1. Azure portal から、Azure portal の右上にあるアイコンをクリックして、Cloud Shell を開きます。 メッセージが表示されたら、 **[再接続]** をクリックします。

1. Cloud Shell ペイン内の PowerShell セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB02" -Force -AsJob
    ```
1.  **[Cloud Shell]** ペインを閉じます。 
  
1. Azure portal で、ページ上部にある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスに「**ポリシー**」と入力し、**Enter** キーを押します。

1. [作成] セクションで **[割り当て]** を選択します。

1. 割り当ての一覧で、このラボで作成した **[許可されている場所]** ポリシーの名前を選択します。

1. ポリシーの割り当てで、 **[割り当ての削除]** を選択し、 **[はい]** を選択します。
