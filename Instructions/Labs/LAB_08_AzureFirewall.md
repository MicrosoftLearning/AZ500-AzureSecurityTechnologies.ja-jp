---
lab:
  title: 08 - Azure Firewall
  module: Module 02 - Implement Platform Protection
---

# <a name="lab-08-azure-firewall"></a>ラボ 08:Azure Firewall
# <a name="student-lab-manual"></a>受講生用ラボ マニュアル

## <a name="lab-scenario"></a>ラボのシナリオ

Azure Firewall のインストールを求められました。 これは、組織が全体的なネットワーク セキュリティ計画の重要な部分である受信および送信ネットワーク アクセスを制御するのに役立ちます。 具体的には、次のインフラストラクチャ コンポーネントを作成してテストします。

- ワークロード サブネットとジャンプ ホスト サブネットを持つ仮想ネットワーク。
- 仮想マシンは各サブネットです。 
- ワークロード サブネットからのすべてのアウトバウンド ワークロード トラフィックがファイアウォールを使用することを保証するカスタム ルート。
- www.bing.com への送信トラフィックのみを許可するファイアウォール アプリケーション ルール。 
- 外部 DNS サーバーのルックアップを許可するファイアウォール ネットワーク ルール。

> このラボのすべてのリソースについて、**米国東部**リージョンを使用しています。 これがクラスで使用するリージョンであることを講師に確認します。 

## <a name="lab-objectives"></a>ラボの目的

このラボでは、次の演習を行います。

- 演習 1:Azure Firewall をデプロイしてテストする

## <a name="azure-firewall-diagram"></a>Azure Firewall の図

![image](https://user-images.githubusercontent.com/91347931/157529954-a1bc434b-2eca-41c1-b875-1f0c977d5e20.png)

## <a name="instructions"></a>Instructions

## <a name="lab-files"></a>ラボ ファイル：

- **\\Allfiles\\Labs\\08\\template.json**

### <a name="exercise-1-deploy-and-test-an-azure-firewall"></a>演習 1:Azure Firewall をデプロイしてテストする

### <a name="estimated-timing-40-minutes"></a>推定時間:40 分

> このラボのすべてのリソースに対して、**東部 (米国)** リージョンを使用しています。 これがクラスで使用するリージョンであることを講師に確認します。 

この演習では、次のタスクを実行します。

- タスク 1:テンプレートを使用してラボ環境を展開します。 
- タスク 2:Azure Firewall をデプロイします。
- タスク 3:既定のルートを作成します。
- タスク 4:アプリケーション ルールを構成します。
- タスク 5:ネットワーク ルールを構成します。 
- タスク 6:DNS サーバーを構成します。
- タスク 7:ファイアウォールをテストします。 

#### <a name="task-1-use-a-template-to-deploy-the-lab-environment"></a>タスク 1:テンプレートを使用してラボ環境を展開します。 

このタスクでは、ラボ環境を確認してデプロイします。 

このタスクでは、ARM テンプレートを使用して仮想マシンを作成します。 この仮想マシンは、このラボの最後の演習で使用されます。 

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**:このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure portal にサインインします。

2. Azure portal で Azure portal ページの上部にある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで、「**カスタム テンプレートをデプロイする**」と入力し、**Enter** キーを押します。

3. **[カスタム デプロイ]** ブレードで、**[エディターで独自のテンプレートを作成する]** オプションをクリックします。

4. **[テンプレートの編集]** ブレードで、 **[ファイルの読み込み]** をクリックし、 **\\Allfiles\\Labs\\08\\template.json** ファイルを見つけて、 **[開く]** をクリックします。

    >**注**:テンプレートの内容を確認し、Windows Server 2019 の Datacenter をホストする Azure VM をデプロイしていることを確認してください。

5. **[テンプレートの編集]** ブレードで、**[保存]** をクリックします。

6. **[カスタム デプロイ]** ブレードで、次の設定が構成されていることを確認します (既定値を使用して他の設定を行います)。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使用する Azure サブスクリプションの名前|
   |リソース グループ|**[新規作成]** をクリックして、「**AZ500LAB08**」という名前を入力します|
   |場所|**(米国) 米国東部**|

    >**注**:Azure VM をプロビジョニングできる Azure リージョンを特定するには、[ **https://azure.microsoft.com/en-us/regions/offers/** ](https://azure.microsoft.com/en-us/regions/offers/) を参照してください

7. **[確認と作成]** をクリックし、**[作成]** をクリックします。

    >**注**: デプロイが完了するまで待ちます。 これには 2 分ほどかかります。 

#### <a name="task-2-deploy-the-azure-firewall"></a>タスク 2:Azure Firewall をデプロイする

このタスクでは、Azure Firewall を Virtual Network にデプロイします。 

1. Azure portal で、Azure portal ページの上部にある **[リソース、サービス、ドキュメントを検索する]** テキスト ボックスで、「**ファイアウォール**」と入力し、**Enter** キーを押します。

2. **[ファイアウォール]** ブレードで、**[+ 追加]** をクリックします。

3. **[ファイアウォールの作成]** ブレードの **[基本]** タブで、次の設定を指定します (他の設定は既定値のままにします)。

   |設定|値|
   |---|---|
   |Resource group|**AZ500LAB08**|
   |名前|**Test-FW01**|
   |リージョン|**(米国) 米国東部**|
   |ファイアウォール レベル|**Standard**|
   |ファイアウォール管理|**ファイアウォール規則 (クラシック) を使用してこのファイアウォールを管理する**|
   |仮想ネットワークの選択|**[既存のものを使用]** オプションをクリックし、ドロップダウン リストで **[Test-FW-VN]** を選択します|
   |パブリック IP アドレス|**[新規追加]** をクリックし、「**TEST-FW-PIP**」という名前を入力して、**[OK]** をクリックします|

4. **[Review + create]\(レビュー + 作成\)** をクリックし、 **[作成]** をクリックします。 

    >**注**: デプロイが完了するまで待ちます。 これには 5 分ほどかかります。 

5. Azure portal で、Azure portal ページの上部にある **[リソース、サービス、ドキュメントを検索する]** テキスト ボックスで、「**リソース グループ**」と入力し、**Enter** キーを押します。

6. **[リソース グループ]** ブレードのリソース グループの一覧で、**[AZ500LAB08]** エントリをクリックします。

    >**注**: **AZ500LAB08** リソース グループのブレードで、リソースのリストを確認します。 **[種類]** で並べ替えることができます。

7. リソースの一覧で、**Test-FW01** ファイアウォールを表すエントリをクリックします。

8. **[Test-FW01]** ブレードで、ファイアウォールに割り当てられた**プライベート IP** アドレスを特定します。 

    >**注**:この情報は次のタスクで必要になります。


#### <a name="task-3-create-a-default-route"></a>タスク 3:既定のルートを作成する

このタスクでは、**Workload-SN** サブネットの既定のルートを作成します。 このルートは、ファイアウォールを経由する送信トラフィックを構成します。

1. Azure portal で、Azure portal ページの上部にある **[リソース、サービス、ドキュメントを検索する]** テキスト ボックスで、「**ルート テーブル**」と入力し、**Enter** キーを押します。

2. **[ルート テーブル]** ブレードで、**[+ 新規]** をクリックします。

3. **[ルート テーブルの作成]** ブレードで、次の設定を指定します。

   |設定|値|
   |---|---|
   |Resource group|**AZ500LAB08**|
   |リージョン| **米国東部**|
   |名前|**Firewall-route**|

4. **[確認と作成]** をクリックし、**[作成]** をクリックして、保存が完了するのを待ちます。 

5. **[ルート テーブル]** ブレードで **[更新]** をクリックし、ルート テーブルの一覧で **[Firewall-route]** エントリをクリックします。

6. **[ファイアウォールルート]** ブレードの **[設定]** セクションで、 **[サブネット]** をクリックし、次に **[ファイアウォールルート \| サブネット]** ブレードで、 **[+ 関連付け]** をクリックします。

7. **[サブネットの関連付け]** ブレードで、次の設定を指定します。

   |設定|値|
   |---|---|
   |仮想ネットワーク|**Test-FW-VN**|
   |Subnet|**Workload-SN**|

    >**注**:このルートに **Workload-SN** サブネットが選択されていることを確認してください。選択されていない場合、ファイアウォールは正しく機能しません。

8. **[OK]** をクリックして、ファイアウォールを仮想ネットワーク サブネットに関連付けます。 

9. **[Firewall-route]** ブレードに戻り、**[設定]** セクションで **[ルート]** をクリックし、**[+ 追加]** をクリックします。 

10. **[ルートの追加]** ブレードで、次の設定を指定します。  

   |設定|値|
   |---|---|
   |ルート名|**FW-DG**|
   |アドレス プレフィックス送信先|**IP アドレス**|
   |宛先 IP アドレス/CIDR 範囲|**0.0.0.0/0**
   |ネクストホップの種類|**仮想アプライアンス**|
   |次ホップ アドレス|前のタスクで特定したファイアウォールのプライベート IP アドレス|

    >**注**:Azure Firewall は実際にはマネージド サービスですが、この状況では仮想アプライアンスが機能します。
    
11.  **[追加]** をクリックしてルートを追加します。 


#### <a name="task-4-configure-an-application-rule"></a>タスク 4:アプリケーション ルールを構成する

このタスクでは、`www.bing.com` への送信アクセスを許可するアプリケーション ルールを作成します。

1. Azure portal で、**Test-FW01** ファイアウォールに戻ります。

2. **[Test-FW01]** ブレードの **[設定]** セクションで、**[ルール (従来)]** をクリックします。

3. **[Test-FW01 \| ルール (従来)]** ブレードで、 **[アプリケーション ルール コレクション]** タブをクリックし、 **[+ アプリケーション ルール コレクションの追加]** をクリックします。

4. **[アプリケーション ルール コレクションの追加]** ブレードで、次の設定を指定します (他の設定は既定値のままにします)。

   |設定|値|
   |---|---|
   |名前|**App-Coll01**|
   |優先度|**200**|
   |アクション|**許可**|

5. **[アプリケーション ルール コレクションの追加]** ブレードで、**[ターゲット FQDN]** セクションに次の設定で新しいエントリを作成します (他の設定は既定値のままにします)。

   |設定|値|
   |---|---|
   |name|**AllowGH**|
   |変換元の型|**IP アドレス**|
   |source|**10.0.2.0/24**|
   |プロトコル ポート|**http:80、https:443**|
   |ターゲット FQDN|**www.bing.com**|

6. **[追加]** をクリックして、ターゲット FQDN ベースのアプリケーション ルールを追加します。

    >**注**:Azure Firewall には、既定で許可されているインフラストラクチャ FQDN 用の組み込みのルール コレクションが含まれています。 これらの FQDN はプラットフォームに固有であり、他の目的には使用できません。 

#### <a name="task-5-configure-a-network-rule"></a>タスク 5:ネットワーク ルールを構成する

このタスクでは、ポート 53 (DNS) の 2 つの IP アドレスへの送信アクセスを許可するネットワーク規則を作成します。

1. Azure portal で、 **[Test-FW01 \| ルール (従来)]** ブレードに戻ります。

2. **[Test-FW01 \| ルール (従来)]** ブレードで、 **[ネットワーク ルール コレクション]** タブをクリックし、 **[+ ネットワーク ルール コレクションを追加]** をクリックします。

3. **[ネットワーク ルール コレクションの追加]** ブレードで、次の設定を指定します (他の設定は既定値のままにします)。

   |設定|値|
   |---|---|
   |名前|**Net-Coll01**|
   |優先度|**200**|
   |アクション|**許可**|

4. **[ネットワーク ルール コレクションの追加]** ブレードで、**[IP アドレス]** セクションに次の設定で新しいエントリを作成します (他の設定は既定値のままにします)。

   |設定|値|
   |---|---|
   |名前|**AllowDNS**|
   |Protocol|**UDP**|
   |変換元の型|**IP アドレス (IP address)**|
   |ソース アドレス|**10.0.2.0/24**|
   |変換先の型|**IP アドレス (IP address)**|
   |Destination Address (宛先アドレス)|**209.244.0.3,209.244.0.4**|
   |ターゲット ポート|**53**|

5. **[追加]** をクリックして、ネットワーク ルールを追加します。

    >**注**:この場合に使用される宛先アドレスは、既知のパブリック DNS サーバーです。 

#### <a name="task-6-configure-the-virtual-machine-dns-servers"></a>タスク 6:仮想マシンの DNS サーバーを構成する

このタスクでは、仮想マシンのプライマリおよびセカンダリ DNS アドレスを構成します。 これはファイアウォール要件ではありません。 

1. Azure portal で、**AZ500LAB08** リソース グループに戻ります。

2. **[AZ500LAB08-RG]** ブレードのリソースの一覧で、**Srv-Work** 仮想マシンをクリックします。

3. **[Srv-Work]** ブレードの **[設定]** セクションで、**[ネットワーク]** をクリックします。

4. **[Srv-Work \| ネットワーク]** ブレードで、 **[ネットワーク インターフェイス]** エントリの横にあるリンクをクリックします。

5. ネットワーク インターフェイス ブレードの **[設定]** セクションで、**[DNS サーバー]** をクリックし、**[カスタム]** オプションを選択して、ネットワーク ルールで参照されている 2 つの DNS サーバー (**209.244.0.3** と **209.244.0.4**) を追加し、**[保存]** をクリックして、変更を保存します。

6. **Srv-Work** 仮想マシンのページに戻ります。

    >**注**:更新が完了するまで待ちます。

    >**注**:ネットワーク インターフェイスの DNS サーバーを更新すると、そのインターフェイスが接続されている仮想マシンが自動的に再起動され、該当する場合は、同じ可用性セット内の他の仮想マシンが再起動されます。

#### <a name="task-7-test-the-firewall"></a>タスク 7:ファイアウォールのテスト

このタスクでは、ファイアウォールをテストして、期待どおりに機能することを確認します。

1. Azure portal で、**AZ500LAB08** リソース グループに戻ります。

2. **[AZ500LAB08]** ブレードのリソースの一覧で、**Srv-Jump** 仮想マシンをクリックします。

3. **[Srv-Jump]** ブレードで **[接続]** をクリックし、ドロップダウン メニューの **[RDP]** をクリックします。 

4. **[RDP ファイルのダウンロード]** をクリックし、それを使用してリモートデスクトップ経由で **Srv-Jump** Azure VM に接続します。 認証を求められたら、次の資格情報を入力します。

   |設定|値|
   |---|---|
   |ユーザー名|**localadmin**|
   |パスワード|**Pa55w.rd1234**|

    >**注**:次の手順は、**Srv-Jump** Azure VM へのリモート デスクトップ セッションで実行されます。 

    >**注**:**Srv-Work** 仮想マシンに接続します。 これは、bing.com の Web サイトにアクセスする機能をテストできるように行われています。  

5. **Srv-Jump** へのリモート デスクトップ セッション内で **[スタート]** を右クリックし、右クリック メニューで **[実行]** をクリックし、**[実行]** ダイアログ ボックスで次のコマンドを実行して、**Srv-Work** に接続します。 

    ```
    mstsc /v:Srv-Work
    ```

6. 認証を求めるプロンプトが表示されたら、次の認証情報を入力します。

   |設定|値|
   |---|---|
   |ユーザー名|**localadmin**|
   |パスワード|**Pa55w.rd1234**|

    >**注**:リモート デスクトップ セッションが確立され、サーバー マネージャー インターフェイスが読み込まれるまで待ちます。

7. **[Srv-Work]** へのリモート デスクトップ セッション内の **[サーバー マネージャー]** で **[ローカル サーバー]** をクリックし、**[IE セキュリティ強化の構成]** をクリックします。

8. **[Internet Explorer セキュリティ強化の構成]** ダイアログ ボックスで、両方のオプションを **[オフ]** に設定し、**[OK]** をクリックします。

9. **Srv-Work** へのリモート デスクトップ セッション内で、Internet Explorer を起動し、 **`https://www.bing.com`** を参照します。 

    >**注**:Web サイトが正常に表示されます。 ファイアウォールでは、アクセスできます。

10. **`http://www.microsoft.com/`** に移動します。

    >**注**:ブラウザー ページ内で、次のようなテキストを含むメッセージが表示されます。`HTTP request from 10.0.2.4:xxxxx to microsoft.com:80. Action: Deny. No rule matched. Proceeding with default action.` ファイアウォールがこの Web サイトへのアクセスをブロックしているため、これは予期された動作です。 

11. 両方のリモート デスクトップ セッションを終了します。

> 結果:Azure Firewall の構成とテストが正常に完了しました。

**リソースをクリーンアップする**

> 新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しないコストが発生しなくなります。 

1. Azure portal から、Azure portal の右上にあるアイコンをクリックして、Cloud Shell を開きます。 メッセージが表示されたら、**[PowerShell]** と **[ストレージの作成]** をクリックします。

2. [Cloud Shell] ペインの左上隅にあるドロップダウン メニューで **[PowerShell]** が選択されていることを確認します。

3. Cloud Shell ペイン内の PowerShell セッションで、次の手順を実行して、このラボで作成したリソース グループを削除します。
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB08" -Force -AsJob
    ```
4. **[Cloud Shell]** ペインを閉じます。 
