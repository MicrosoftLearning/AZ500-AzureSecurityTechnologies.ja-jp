---
lab:
    title: '13 - Azure Monitor'
    module: 'モジュール 04 - セキュリティ操作の管理'
---

# 課題 13: Azure Monitor
# 受講生用ラボ マニュアル

## ラボ シナリオ

仮想マシンのパフォーマンスを監視するという概念実証を作成するように求められました。具体的には、次のことを行います。

- テレメトリとログを収集できるように仮想マシンを構成します。
- 収集できるテレメトリとログを表示します。
- データの使用方法とクエリ方法を示します。 

> このラボのすべてのリソースについて、**米国東部** リージョンを使用しています。クラスに使用する地域であることを講師に確認します。 

## ラボの目的

このラボでは、次の演習を行います。

- 演習 1: Azure Monitor を使用して Azure Virtual Machine からデータを収集する

### 演習 1: Azure Monitor を使用して Azure Virtual Machine からデータを収集する

### 演習のタイミング: 20 分

この演習では、次のタスクを行います。 

- タスク 1: Azure Virtual Machine をデプロイする 
- タスク 2: Log Analytics ワークスペースの作成
- タスク 3: Log Analytics 仮想マシン拡張機能を有効にする
- タスク 4: 仮想マシン イベントおよびパフォーマンス データを収集する
- タスク 5: 収集したデータの表示と照会 

#### タスク 1: Azure Virtual Machine をデプロイする

1. Azure portal **`https://portal.azure.com/`** にサインインします。

    >**注**: このラボで使用している Azure サブスクリプションで所有者ロールまたは共同作成者ロールを持つアカウントを使用して Azure ポータルにサインインします。

1. Azure portal の右上にある最初のアイコンをクリックして、Cloud Shell を開きます。メッセージが表示されたら、「**PowerShell**」 と 「**ストレージの作成**」 を選択します。

1. 「Cloud Shell」 ウィンドウの左上隅にあるドロップダウン メニューで 「**PowerShell**」 が選択されていることを確認します。

1. 「Cloud Shell」 ウィンドウ内の PowerShell セッションで、次の手順を実行して、このラボで使用するリソース グループを作成します。
  
    ```powershell
    New-AzResourceGroup -Name AZ500LAB131415 -Location 'EastUS'
    ```

    >**注**: このリソース グループは、ラボ 13、14、および 15 に使用されます。 

1. 「Cloud Shell」 ウィンドウ内の PowerShell セッションで、次の手順を実行して、新しい Azure Virtual Machine を作成します。 

    ```powershell
    New-AzVm -ResourceGroupName "AZ500LAB131415" -Name "myVM" -Location 'EastUS' -VirtualNetworkName "myVnet" -SubnetName "mySubnet" -SecurityGroupName   "myNetworkSecurityGroup" -PublicIpAddressName "myPublicIpAddress" -OpenPorts 80,3389
    ```

1.  資格情報の入力を求められた場合:

    |設定|値|
    |---|---|
    |ユーザー |**localadmin**|
    |パスワード|**Pa55w.rd1234**|

    >**注**: デプロイが完了するのを待ちます。 

1. 「Cloud Shell」 ウィンドウ内の PowerShell セッションで、次のコマンドを実行して、**myVM** という名前の仮想マシンが作成され、その 「**ProvisioningState**」 が 「**Succeeded**」 であることを確認します。

    ```powershell
    Get-AzVM -Name 'myVM' -ResourceGroupName 'AZ500LAB131415' | Format-Table
    ```

1. 「Cloud Shell」 ペインを閉じます。 

#### タスク 2: Log Analytics ワークスペースの作成

このタスクでは、Log Analytics ワークスペースを作成します。 

1. Azure portal ページの上部にある 「**リソース、サービス、ドキュメントの検索**」 テキスト ボックスで、「**Log Analytics ワークスペース**」と入力し、**Enter** キーを押します。

1. 「**Log Analytics ワークスペース**」ブレードで、「**+ 作成**」をクリックします。

1. 「**Log Analytics ワークスペースの作成**」 ブレードの 「**基本**」 タブで 、次の設定を指定します (既定値を他のユーザーのままにします)。

    |設定|値|
    |---|---|
    |サブスクリプション|このラボで使用している Azure サブスクリプションの名前|
    |リソース グループ|**AZ500Lab131415**|
    |名前|有効で、グローバルにユニークな任意の名前|
    |地域|**米国東部**|

1. 「**次:価格レベル >**」 をクリックし 「**Log Analytics ワークスペースの作成**」 ブレードの 「**価格レベル**」 タブで 、既定の**従量課金制 （1GB あたり（2018））** の価格レベルを受け入れ 、「**価格および作成**」 をクリックします。

1. 「**Log Analytics ワークスペースの作成**」 ブレードの 「**価格および作成**」 タブで、「**作成**」 をクリックします。

#### タスク 3: Log Analytics 仮想マシン拡張機能を有効にする

このタスクでは、Log Analytics 仮想マシン拡張機能を有効にします。この拡張機能は、Windows および Linux Virtual Machines に Log Analytics エージェントをインストールします。このエージェントは、仮想マシンからデータを収集し、指定した Log Analytics ワークスペースに転送します。エージェントがインストールされると、自動的にアップグレードされ、常に最新の機能と修正プログラムが提供されます。 

1. Azure portal で、「**Log Analytics ワークスペース**」 ブレードに戻り、ワークスペースの一覧で、前のタスクで作成したワークスペースを表すエントリをクリックします。

1. 「Log Analytics ワークスペース」ブレードの「**データ ソースの接続**」セクションで、「**Azure Virtual Machines**」エントリをクリックします。

    >**注**: エージェントを正常にインストールするには、仮想マシンが実行されている必要があります。

1. 仮想マシンの一覧で、この演習の最初のタスクでデプロイした Azure VM **myVM** を表すエントリを見つけ 、そのエントリが 「**接続されていません**」 と表示されていることに注意してください。

1. **myVM** エントリをクリックし、次に 「**myVM**」 ブレードで 「**接続**」 をクリックします。 

1. 仮想マシンが Log Analytics ワークスペースに接続するまで待ちます。

    >**注**: これには数分かかる場合があります。「**myVM**」 ブレードに表示される 「**状態**」 は 「**接続しています**」 から 「**このワークスペース**」 に変わります。 

#### タスク 4: 仮想マシン イベントおよびパフォーマンス データを収集する

このタスクでは、Windows システム ログのコレクションといくつかの一般的なパフォーマンス カウンターを構成します。また、使用可能な他のソースも確認します。

1. Azure portal で、この演習で前に作成した Log Analytics ワークスペースに戻ります。

1. 「Log Analytics ワークスペース」 ブレードの 「**設定**」 セクションで、「**エージェント構成**」 をクリックします。

1. 「**エージェント構成**」 ブレードで、Windows イベント ログ、Windows パフォーマンス カウンター、Linux パフォーマンス カウンター、IIS ログ、Syslog などの構成可能な設定を確認します。 

1. 「**Windows イベントログ**」が選択されていることを確認し、「**+ Windows イベントログを追加**」をクリックします。イベントログの種類のリストで、「**System**」を選択します。

    >**注**: これは、ワークスペースにイベント ログを追加する方法です。その他の選択肢としては、**ハードウェア イベント** や **キー管理サービス** などがあります。  

1. **「情報」** チェックボックスの選択を解除し、**「エラー」** チェックボックスと **「警告」** チェックボックスを選択したままにします。

1. **「Windows パフォーマンス カウンター」** タブをクリックし、**「+ パフォーマンス カウンターの追加」** をクリックして、使用可能なパフォーマンス カウンターのリストを確認し、次のものを追加します。

    - Process(\*)\%Processor Time
    - Event Tracing for Windows\Total Memory Usage --- Non-Paged Pool
    - Event Tracing for Windows\Total Memory Usage --- Paged Pool

    >**注**: カウンターが追加され、60 秒の収集サンプル間隔で構成されます。
  
1. 「**エージェントの構成**」 ブレードで、「**適用**」 をクリックします。

#### タスク 5: 収集したデータの表示と照会

このタスクでは、データ コレクションに対してログ検索を実行します。 

1. Azure portal で、この演習で前に作成した Log Analytics ワークスペースに戻ります。

1. 「Log Analytics ワークスペース」 ブレードの 「**全般**」 セクションで、「**ログ**」 をクリックします。

1. 必要に応じて、「**Log Analysis へようこそ**」ウィンドウを閉じます。 

1. 「**クエリ**」ペインの「**すべてのクエリ**」列で、リソース タイプの一覧の一番下までスクロールして、「**仮想マシン**」をクリックします。
    
1. 定義済みクエリの一覧を確認し、テストするクエリを特定し、対応する 「**実行**」 ボタンをクリックします。

    >**注**: **Virtual Machine available memory** というクエリから始めることができます。結果が出ない場合は、スコープが仮想マシンに設定されていることを確認してください。データが収集されるまで結果は表示されません。

1. クエリは、「新しいクエリ」 タブで自動的に開きます。 

    >**注**: Log Analytics では、Kusto クエリ言語が使用されます。既存のクエリをカスタマイズすることも、独自のクエリを作成することもできます。 

    >**注**: 選択したクエリの結果は、クエリ ウィンドウの下に自動的に表示されます。クエリを再実行するには、「**実行**」 をクリックします。

    >**注**: この仮想マシンは作成されたばかりなので、まだデータが存在しない可能性があります。 

    >**注**: データを異なる形式で表示するオプションがあります。また、クエリの結果に基づいてアラート ルールを作成することもできます。

    > **注**: 以下の手順で、このラボで前にデプロイした Azure VM に追加の負荷を生成することができます。

    1. Azure VM ブレードに移動します。
    2. Azure VM ブレードの「**操作**」セクションで、「**コマンドを実行**」を選択し、「**RunPowerShellScript**」ブレードで次のスクリプトを入力し、「**実行**」をクリックします。
    3. 
       ```cmd
       cmd
       :loop
       dir c:\ /s > SWAP
       goto loop
       ```
       
    1. Log Analytics ブレードに切り替えて、クエリを再実行します。データが収集されるまで数分待って、再度クエリを実行する必要があるかもしれません。

> 結果: Log Analytics ワークスペースを使用して、データ ソースとクエリ ログを構成しました。 

**リソースをクリーン アップする**

>**注**: Azure Security Center ラボおよび Azure Sentinel ラボに必要なリソースは、このラボから削除しないでください。
 
